---
# You can also start simply with 'default'
theme: academic
# random image from a curated Unsplash collection by Anthony
# like them? see https://unsplash.com/collections/94734566/slidev
# background: https://cover.sli.dev
highlighter: shiki
# some information about your slides (markdown enabled)
title: W10-Linking
info: |
  ICS 2025 Fall Slides
titleTemplate: '%s'
# apply unocss classes to the current slide
class: text-center
# https://sli.dev/features/drawing
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade-out
# enable MDC Syntax: https://sli.dev/features/mdc
mdc: true
layout: cover
coverBackgroundUrl: /newres/image/W10/1.jpg

---

# Linking {.font-bold}

<p class="text-gray-100">
<font size = '5'>
  å…ƒåŸ¹æ•°ç§‘ ç‹æ©åš
</font>
</p>

<div class="pt-12  text-gray-1">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Let's get started <carbon:arrow-right class="inline"/>
  </span>
</div>


<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
  <a href="https://github.com/WEB-05/WEB-ICS-TA-Slides2025
  " target="_blank" alt="GitHub" title="Open in GitHub"
    class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon-logo-github />
  </a>
</div>

<style>
  div{
   @apply text-gray-2;
  }
</style>



---
layout: center
---

<div style="text-align: center;">
  <text class="text-17 font-bold gradient-text">Knowledge Review</text>
  <br />
</div>


<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---
layout: center
---

<div style="text-align: center;">
  <text class="text-17 font-bold gradient-text">Program optimization</text>
  <br />
</div>


<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# ç¼–è¯‘å™¨èƒ½åŠ›ä¸å±€é™
Capabilities

å¯¹ç¨‹åºåªä½¿ç”¨**å®‰å…¨**çš„ä¼˜åŒ–,ä¿è¯**ä¸€å®šä¸ä¼š**æ”¹å˜ç¨‹åºè¡Œä¸º

ä¾‹1ï¼šä»£ç ç§»åŠ¨

![1](./newres/image/W10/1.png){.w-250}

---

# ç¼–è¯‘å™¨èƒ½åŠ›ä¸å±€é™
Capabilities

å¯¹ç¨‹åºåªä½¿ç”¨**å®‰å…¨**çš„ä¼˜åŒ–,ä¿è¯**ä¸€å®šä¸ä¼š**æ”¹å˜ç¨‹åºè¡Œä¸º

ä¾‹2ï¼šç”¨ç®€å•çš„æ“ä½œæ›¿æ¢å¤æ‚æ“ä½œ

- ç§»ä½å’ŒåŠ å‡æ³•ä»£æ›¿ä¹˜æ³•

- ![2](./newres/image/W10/2.png){.w-250}

---

# ç¼–è¯‘å™¨èƒ½åŠ›ä¸å±€é™
Capabilities

å¯¹ç¨‹åºåªä½¿ç”¨**å®‰å…¨**çš„ä¼˜åŒ–,ä¿è¯**ä¸€å®šä¸ä¼š**æ”¹å˜ç¨‹åºè¡Œä¸º

ä¾‹3ï¼šè¡¨è¾¾å¼é‡ç”¨

![3](./newres/image/W10/3.png){.w-250}

---

# ç¼–è¯‘å™¨èƒ½åŠ›ä¸å±€é™
Limitations

**ä¸å®‰å…¨çš„æƒ…å†µ1**ï¼š

- å†…å­˜åˆ«åä½¿ç”¨ï¼š
```c++
void func1(long *xp,long *yp)
{
  *xp += *yp;
  *xp += *yp;
}

void func2(long *xp,long *yp)
{
  *xp += 2 * *yp;
}
```

- ç‰¹ç‚¹ ï¼šæœ‰**æŒ‡é’ˆ/æ•°ç»„**ç­‰ï¼Œè€ƒè™‘å¯èƒ½æŒ‡å‘åŒä¸€ä½ç½®

---

# ç¼–è¯‘å™¨èƒ½åŠ›ä¸å±€é™
Limitations

**ä¸å®‰å…¨çš„æƒ…å†µ2**ï¼š

- å‡½æ•°è°ƒç”¨ï¼š
```c++
int a = 0;
int fun()
{
  return a++;
}
int func1()
{
  return fun()+fun()+fun()+fun();
}

void func2()
{
  return fun() * 4;
}
```

- ç‰¹ç‚¹ ï¼šæœ‰**å‡½æ•°è°ƒç”¨**ï¼Œè€ƒè™‘ä¸æ¸…æ¥šå‡½æ•°å…·ä½“æ“ä½œæ˜¯å¦æœ‰å‰¯ä½œç”¨
- ä¼˜åŒ– ï¼š **å†…è”å‡½æ•°è°ƒç”¨**
---

# è¡¨ç¤ºç¨‹åºæ€§èƒ½

## CPE

- cycles per element
- å»¶è¿Ÿã€ååé‡
- å»¶è¿Ÿç•Œé™ã€ååé‡ç•Œé™
- ååé‡ç•Œé™æ˜¯ç¨‹åºæ€§èƒ½çš„æœ€ç»ˆé™åˆ¶

![Clip_2024-10-30_13-51-21](./res/image/slides.assets/Clip_2024-10-30_13-51-21.png){.w-150}

---

# ä¼˜åŒ–ç¤ºä¾‹
å¼€ç¼–è¯‘å™¨çš„ä¼˜åŒ–å¾ˆæœ‰ç”¨


![4](./newres/image/W10/4.png){.w-150}
![6](./newres/image/W10/6.png){.w-150}

---

# å¾ªç¯æ•ˆç‡
Eliminating Loop Inefficiencies

ä»£ç ç§»åŠ¨ï¼Œç§»å‡ºå¾ªç¯ <br>
æœ‰**å‡½æ•°è°ƒç”¨**æ—¶ï¼Œç¼–è¯‘å™¨å¾ˆå¯èƒ½æ— æ³•è‡ªåŠ¨è¿›è¡Œ
![5](./newres/image/W10/5.png){.w-100}
![7](./newres/image/W10/7.png){.w-150}

---

# å‡å°‘è¿‡ç¨‹è°ƒç”¨
Reducing Procedure Calls


![8](./newres/image/W10/8.png){.w-150}

---

# å†…å­˜è¯»å†™
Eliminating Unneeded Memory References

å‡å°‘å†…å­˜è¯»å†™æ¬¡æ•°ï¼Œå†…å­˜è¯»å†™ä»£ä»·å¤§ <br>
å¯èƒ½æœ‰**åˆ«åå¼•ç”¨**ï¼Œç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨è¿›è¡Œ
![9](./newres/image/W10/9.png){.w-100}
![10](./newres/image/W10/10.png){.w-150}

---

# ç°ä»£å¤„ç†å™¨
Modern Processors

- è¶…æ ‡é‡ã€ä¹±åºã€æŒ‡ä»¤çº§å¹¶è¡Œ
- å–æŒ‡ï¼šæŠ•æœºæ‰§è¡Œ
- è¯‘ç ï¼šå¤æ‚æŒ‡ä»¤æ‹†ä¸ºå¾®æ“ä½œ
- æŠ•æœºæ‰§è¡Œç»“æœä¸ä¼šæ”¾åœ¨ç¨‹åºå¯„å­˜å™¨æˆ–æ•°æ®å†…å­˜ä¸­
- é€€å½¹å•å…ƒ ï¼šä¸€æ¡æŒ‡ä»¤æ“ä½œå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰åˆ†æ”¯ç‚¹é¢„æµ‹æ­£ç¡®ï¼Œé€€å½¹ã€‚æ›´æ–°ç¨‹åºå¯„å­˜å™¨
- å¯„å­˜å™¨é‡å‘½åï¼š æ“ä½œæ•°åœ¨æ‰§è¡Œå•å…ƒé—´ä¼ é€’
- é‡å‘½åè¡¨ ï¼š æœªè¿›è¡Œå†™æ“ä½œçš„å¯„å­˜å™¨
- æŒ‡ä»¤1æ›´æ–°rï¼ŒåŠ å…¥(r,t)
- åç»­æŒ‡ä»¤éœ€è¦r,ç­‰å¾…1æ‰§è¡Œå®Œæ¯•åŠ å…¥(v,t),ä»¥væ“ä½œæ•°å€¼

---

# åŠŸèƒ½å•å…ƒæ€§èƒ½
Functional Unit Performance

![11](./newres/image/W10/11.png){.w-150}
- å‘å°„æ—¶é—´ä¸º 1ï¼šå®Œå…¨æµæ°´çº¿åŒ–
![12](./newres/image/W10/12.png){.w-120}
- åŠ æ³•ååé‡ç•Œé™å—åˆ°å†…å­˜è¯»å–æ•°æ®é™åˆ¶ï¼Œä¸€ä¸ªå‘¨æœŸæœ€å¤šè¯»ä¸¤ä¸ªæ•°æ®

---

# å›é¡¾ä¹‹å‰ä¼˜åŒ–ç»“æœ
Review

![9](./newres/image/W10/9.png){.w-80}
![13](./newres/image/W10/13.png){.w-150}
- ä¸€æ¬¡ä¸€ä¸ªäº’ç›¸é™åˆ¶ï¼Œå› æ­¤æ¥è¿‘å»¶è¿Ÿç•Œé™

---

# æ•°æ®æµå›¾+å…³é”®è·¯å¾„
Critical Path

- å…³æ³¨å¾ªç¯å¯„å­˜å™¨
- åªæ˜¯ä¸‹ç•Œï¼Œå…¶ä»–ï¼šåŠŸèƒ½å•å…ƒæ•°é‡ï¼ˆå¤Ÿä¸å¤Ÿå¹¶è¡Œçš„ï¼‰ã€ä¼ é€’æ•°æ®å€¼çš„æ•°é‡
- æ•´æ•°åŠ æ³•ï¼šåŠ æ³•å¾ˆå¿«ï¼Œå…¶ä»–æ“ä½œä¾›åº”ä¸å¤Ÿ

<div grid="~ cols-2 gap-2">

<div>

![Clip_2024-10-30_13-51-48](./res/image/slides.assets/Clip_2024-10-30_13-51-48.png)


</div>

<div>


![Clip_2024-10-30_13-52-02](./res/image/slides.assets/Clip_2024-10-30_13-52-02.png){.w-70}


</div>
</div>

---

# å¾ªç¯å±•å¼€
Loop Unrolling

## k*1
<div grid="~ cols-2 gap-2">

<div>

![14](./newres/image/W10/14.png){.w-80}

</div>

<div>

![15](./newres/image/W10/15.png){.w-150}

</div>
</div>

- å‡å°‘å¾ªç¯å¼€é”€ï¼Œä½†ä¸ä½äºå»¶è¿Ÿç•Œé™

---

# k*1ä¸ä½äºå»¶è¿Ÿç•Œé™
Whyï¼Ÿ

<div grid="~ cols-2 gap-2">

<div>

![16](./newres/image/W10/16.png){.w-80}

</div>

<div>

![17](./newres/image/W10/17.png){.w-30}

</div>
</div>

---


# æé«˜å¹¶è¡Œæ€§
Enhancing Parallelism



- å¾ªç¯å±•å¼€ï¼š`acc = (acc OP data[i]) OP data[i+1]`
- å¤šä¸ªç´¯è®¡å˜é‡ï¼š`acc0 = acc0 OP data[i], acc1 = acc1 OP data[i+1]`
  - $CPE$ ä¸ºæ»¡ï¼Œéœ€è¦æ‰§è¡Œè¯¥æ“ä½œçš„æ‰€æœ‰åŠŸèƒ½å•å…ƒçš„æµæ°´çº¿éƒ½æ˜¯æ»¡çš„â€”â€”**ååé‡ç•Œé™**
  - $k\times k$ å¾ªç¯å±•å¼€ï¼š$k\ge C\cdot L$ï¼Œå»¶è¿Ÿ$C$ï¼Œå®¹é‡$L$
- é‡æ–°ç»“åˆå˜æ¢ï¼š`acc = acc OP (data[i] OP data[i+1])`

<br/>

## å±€é™æ€§

- å¯„å­˜å™¨æº¢å‡º
- åˆ†æ”¯é¢„æµ‹å¤„ç½šï¼ˆé¿å…æ–¹æ³•ï¼šå¯é¢„æµ‹çš„åˆ†æ”¯ã€æ¡ä»¶ä¼ é€ï¼‰
- ä¸å¯é‡æ’çš„è¿ç®—

---

# å¤šä¸ªç´¯è®¡å˜é‡
Multiple Accumulators

## k*k
<div grid="~ cols-2 gap-2">

<div>

![18](./newres/image/W10/18.png){.w-80}

</div>

<div>

![19](./newres/image/W10/19.png){.w-150}

</div>
</div>

---

# å¤šä¸ªç´¯è®¡å˜é‡
Multiple Accumulators

<div grid="~ cols-2 gap-2">

<div>

![20](./newres/image/W10/20.png){.w-100}

</div>

<div>

![21](./newres/image/W10/21.png){.w-50}

</div>
</div>

---

# é‡æ–°ç»“åˆå˜æ¢
Reassociation Transformation

## 2*1a
<br>

```c++
acc = acc OP (data[i] OP data[i+1])
```


![23](./newres/image/W10/23.png){.w-150}

---

# é‡æ–°ç»“åˆå˜æ¢
Reassociation Transformation

<div grid="~ cols-2 gap-2">

<div>

![25](./newres/image/W10/25.png){.w-100}

</div>

<div>

![26](./newres/image/W10/26.png){.w-50}

</div>
</div>

---

# å†…å­˜æ€§èƒ½
Memory Performance

- load ï¼šä¸cacheçš„è®¿é—®å‘¨æœŸæœ‰å…³
- store ï¼šå®Œå…¨æµæ°´çº¿åŒ–
- å†™/è¯»ç›¸å…³ ï¼šæ£€æŸ¥åœ°å€æ˜¯å¦ç›¸åŒ

<div grid="~ cols-2 gap-2">

<div>

![27](./newres/image/W10/27.png){.w-80}

</div>

<div>

![28](./newres/image/W10/28.png){.w-80}

</div>
</div>

---

# å†™/è¯»ç›¸å…³
Write/Read Dependency

![29](./newres/image/W10/29.png){.w-60}

---
layout: center
---

<div style="text-align: center;">
  <text class="text-17 font-bold gradient-text">Linking</text>
  <br />
</div>


<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---

# é“¾æ¥

Linking

**é“¾æ¥**ï¼šå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ç»„åˆæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚

**ç›®æ ‡æ–‡ä»¶**ï¼šç¼–è¯‘å™¨å°†æºä»£ç æ–‡ä»¶ç¼–è¯‘åçš„äº§ç‰©ï¼Œä½†è¿˜æœªé“¾æ¥æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

**å¯æ‰§è¡Œæ–‡ä»¶**ï¼šé“¾æ¥åçš„æœ€ç»ˆäº§ç‰©ï¼Œè¿™ä¸ªæ–‡ä»¶å¯è¢«åŠ è½½ï¼ˆå¤åˆ¶ï¼‰åˆ°å†…å­˜å¹¶æ‰§è¡Œã€‚

é“¾æ¥åœ¨ **ç¼–è¯‘æ—¶ã€åŠ è½½æ—¶ã€è¿è¡Œæ—¶** å‡å¯æ‰§è¡Œï¼ˆåæ–‡ä¼šè¯´éƒ½æ˜¯å•¥ï¼‰ã€‚

é“¾æ¥çš„ä¼˜åŠ¿ï¼š

- **ä»£ç æ¨¡å—åŒ–**ï¼šæ–¹ä¾¿æŸ¥æ‰¾é—®é¢˜ä¸ç»´æŠ¤ï¼Œå¯ä»¥å»ºç«‹å¸¸è§å‡½æ•°çš„åº“
- **æ—¶é—´å’Œç©ºé—´æ•ˆç‡**ï¼šåªéœ€è¦æ”¹ä¸€å¤„ä»£ç å¯åŒæ—¶å½±å“å¤šä¸ªä»£ç ï¼Œåªä¼šç¼–è¯‘ä½ å¼•ç”¨çš„åº“ä¸­ç”¨åˆ°çš„ä»£ç 



---

# ä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶

From source code to executable file

![compile_system](./res/image/slides.assets/compile_system.png)
ç ”è®¨é¢˜1.1
$$
\text{.c} \xrightarrow{\text{cpp}} \text{.i} \xrightarrow{\text{cc1}} \text{.s} \xrightarrow{\text{as}} \text{.o} \xrightarrow{\text{ld}} \text{prog}
$$

<div class="text-sm">

<v-clicks>


- `gcc`ï¼šç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº
- `cpp`ï¼šC é¢„å¤„ç†ï¼ˆc preprocessorï¼‰ï¼Œå°† xx.c ç¿»è¯‘æˆä¸€ä¸ª ASCII ç çš„ **ä¸­é—´æ–‡ä»¶**{.text-sky-5} xx.iï¼ˆintermediate fileï¼‰
- `cc1`ï¼šC ç¼–è¯‘å™¨ï¼ˆc compilerï¼‰ï¼Œå°† xx.i ç¿»è¯‘æˆä¸€ä¸ª ASCII **æ±‡ç¼–è¯­è¨€æ–‡ä»¶**{.text-sky-5} xx.sï¼ˆassembly language fileï¼‰
- `as`ï¼šæ±‡ç¼–å™¨ï¼ˆassemblerï¼‰ï¼Œå°† xx.s ç¿»è¯‘æˆä¸€ä¸ª **å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**{.text-sky-5} xx.oï¼ˆrelocatable object fileï¼‰
- `ld`ï¼šé“¾æ¥å™¨ï¼ˆlinkerï¼‰ï¼Œå°† xx.o å’Œå…¶ä»–çš„ xx.oï¼Œä»¥åŠå¿…è¦çš„ç³»ç»Ÿç›®æ ‡æ–‡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ª**å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶**{.text-sky-5} prog

</v-clicks>


</div>



---

# é™æ€é“¾æ¥

Static Linking


<div grid="~ cols-2 gap-12">
<div>

### main.c
```c
int sum(int *a, int n);  // è¿™é‡Œå£°æ˜äº†å‡½æ•°ï¼Œä½†æœªå®šä¹‰
int array[2] = {1, 2};  

int main()  
{  
    int val = sum(array, 2);  
    return val;  
}
```

### sum.c
```c
int sum(int *a, int n)   // è¿™é‡Œå®šä¹‰äº†å‡½æ•°
{  
    int i, s = 0;  
    for (i = 0; i < n; i++) {  
        s += a[i];  
    }  
    return s;  
}
```

</div>

<div flex="~ col gap-4 justify-center items-center">

![compile_system](./res/image/slides.assets/compile_system.png)

![static_linking](./res/image/slides.assets/static_linking.png){.h-60}

</div>
</div>


---

# é™æ€é“¾æ¥

Static Linking

ç ”è®¨é¢˜1.3

åœ¨é™æ€é“¾æ¥ä¸­ï¼Œé“¾æ¥å™¨éœ€è¦å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

- **ç¬¦å·è§£æ**{.text-sky-5}ï¼šå°† **ç¬¦å·å¼•ç”¨** ä¸è¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ **ç¬¦å·è¡¨** ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·ï¼ˆå…¨å±€å˜é‡ã€å‡½æ•°ç­‰ï¼‰å…³è”èµ·æ¥ã€‚
- **é‡å®šä½**{.text-sky-5}ï¼š**åˆå¹¶é‡å®šä½è¾“å…¥æ¨¡å—**ï¼Œå°†ç¬¦å·å®šä¹‰ä¸ä¸€ä¸ªåœ°å€å…³è”èµ·æ¥ï¼Œå¹¶ä¸ºæ‰¾åˆ°çš„æ¯ä¸ªç¬¦å·æŒ‡å‘å¯¹åº”çš„è¯¥åœ°å€ã€‚

å¥½å¤„ï¼š
- å¤ç”¨ä¸€äº›å¸¸ç”¨å‡½æ•°ï¼Œä¸ç”¨è‡ªå·±å†™ã€‚
- æŠŠå‡½æ•°å†™åœ¨å¤šä¸ªæ–‡ä»¶é‡Œï¼Œæ–¹ä¾¿ç»´æŠ¤ã€‚
- ç¼–è¯‘æ›´æœ‰æ•ˆç‡ã€‚



---

# ç›®æ ‡æ–‡ä»¶

Object File

1. **å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**
   - è¿™æ˜¯ä¸€ä¸ªåŒ…å«è®¡ç®—æœºèƒ½ç›´æ¥ç†è§£çš„ä»£ç å’Œæ•°æ®çš„æ–‡ä»¶ï¼Œ**ä½†å®ƒè¿˜ä¸èƒ½å•ç‹¬è¿è¡Œ**{.text-sky-5}ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªåŠæˆå“ï¼Œéœ€è¦å’Œå…¶ä»–åŠæˆå“åˆå¹¶åœ¨ä¸€èµ·æ‰èƒ½å˜æˆä¸€ä¸ªå®Œæ•´çš„äº§å“ã€‚
2. **å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶**
   - è¿™æ˜¯ä¸€ä¸ªå·²ç»å‡†å¤‡å¥½ **å¯ä»¥ç›´æ¥åœ¨è®¡ç®—æœºä¸Šè¿è¡Œçš„æ–‡ä»¶**{.text-sky-5}ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªå·²ç»ç»„è£…å¥½çš„ç©å…·ï¼Œæ‹¿åˆ°æ‰‹å°±å¯ä»¥ç©äº†ï¼Œä¸éœ€è¦å†åšå…¶ä»–æ“ä½œã€‚
3. **å…±äº«ç›®æ ‡æ–‡ä»¶**
   - **ç‰¹æ®Šç±»å‹çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**{.text-sky-5}ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ **åŠ¨æ€åŠ è½½**{.text-sky-5} è¿›æ¥ä½¿ç”¨ã€‚
   - å®ƒå°±åƒæ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è£…ä¸Šå»ï¼Œä¸éœ€è¦çš„æ—¶å€™å¯ä»¥å–ä¸‹æ¥ã€‚



---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File ç ”è®¨é¢˜1.6

<div grid="~ cols-2 gap-12">
<div>

```
ELF å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶
â”‚
â”œâ”€â”€ ELF å¤´ï¼ˆELF Headerï¼‰[ä½åœ°å€]
â”‚
â”œâ”€â”€ èŠ‚ï¼ˆSectionsï¼‰
â”‚   â”œâ”€â”€ .textï¼ˆæœºå™¨ä»£ç ï¼‰
â”‚   â”œâ”€â”€ .rodataï¼ˆåªè¯»æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .dataï¼ˆå·²åˆå§‹åŒ–æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .bssï¼ˆæœªåˆå§‹åŒ–æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ .symtabï¼ˆç¬¦å·è¡¨ï¼‰
â”‚   â”œâ”€â”€ .rel.textï¼ˆé‡å®šä½ä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ .rel.dataï¼ˆé‡å®šä½ä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ .debugï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
â”‚   â””â”€â”€ .strtabï¼ˆå­—ç¬¦ä¸²è¡¨ï¼‰
â”‚
â”œâ”€â”€ èŠ‚å¤´éƒ¨è¡¨ï¼ˆSection Header Tableï¼‰[é«˜åœ°å€]
â”‚   â”œâ”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® 1
â”‚   â”œâ”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® 2
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ èŠ‚å¤´éƒ¨æ¡ç›® N
```

</div>

<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>


---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### ELF å¤´

å­˜å‚¨å…³äºè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸€èˆ¬ä¿¡æ¯ï¼š

æ–‡ä»¶çš„ç±»å‹ã€å­—èŠ‚åºã€ELF å¤´é•¿åº¦ã€èŠ‚å¤´éƒ¨è¡¨åç§»é‡ã€èŠ‚å¤´éƒ¨è¡¨æ¡ç›®å¤§å°å’Œæ•°é‡ç­‰ä¿¡æ¯ã€‚

è¿è¡Œæ—¶ï¼Œä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ï¼š

1. å…ˆå®šä½åˆ° ELF å¤´
2. ç„¶åæ ¹æ® ELF å¤´ä¸­çš„ä¿¡æ¯æ‰¾åˆ°èŠ‚å¤´éƒ¨è¡¨
3. å†æ ¹æ®èŠ‚å¤´éƒ¨è¡¨æ‰¾åˆ°ç›¸åº”çš„èŠ‚

</div>

<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>


---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚


`.text`ï¼šå·²ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç 

`.rodata`ï¼šåªè¯»<span class="text-sm text-gray-5">ï¼ˆread-onlyï¼‰</span>æ•°æ®ï¼Œå¦‚ `printf` ä¸­çš„æ ¼å¼ä¸²ã€å¼€å…³è¯­å¥çš„è·³è½¬è¡¨ã€å­—ç¬¦ä¸²å¸¸é‡ç­‰

`.data`ï¼š<span text-sky-5> å·²åˆå§‹åŒ–çš„å…¨å±€ä¸é™æ€ C å˜é‡</span>

`.bss`ï¼š<span text-sky-5> æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€ C å˜é‡ï¼Œä»¥åŠæ‰€æœ‰è¢«åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å’Œé™æ€ C å˜é‡</span><br><span class="text-sm text-gray-5">ï¼ˆBlock Storage Start / Better Save Spaceï¼‰</span>

<span class="text-sm text-gray-5">

\* å°†åˆå§‹åŒ–ä¸º 0 çš„å˜é‡æ”¾åœ¨ `.bss` æ®µè€Œä¸æ˜¯ `.data` æ®µï¼Œå¯ä»¥ä½¿å¯æ‰§è¡Œæ–‡ä»¶æ›´å°ï¼Œå› ä¸º `.bss` æ®µåªéœ€è¦è®°å½•å˜é‡çš„å¤§å°å’Œä½ç½®ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å®é™…çš„ 0 å€¼ï¼ˆç›´åˆ°è¿è¡Œæ—¶æ‰çœŸçš„å»å†…å­˜ä¸­åˆ†é…ç©ºé—´ï¼‰ã€‚

</span>

</div>


<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>



---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚


`.symtab`ï¼šç¬¦å·è¡¨ <span class="text-sm text-gray-5">ï¼ˆsymbol tableï¼‰</span>ï¼Œå­˜æ”¾å®šä¹‰å’Œå¼•ç”¨çš„å‡½æ•°ä¸å…¨å±€å˜é‡ä¿¡æ¯

`.rel.text`ï¼šé‡å®šä½ä¿¡æ¯ <span class="text-sm text-gray-5">ï¼ˆrelocate textï¼‰</span>

`.rel.data`ï¼šé‡å®šä½ä¿¡æ¯ <span class="text-sm text-gray-5">ï¼ˆrelocate dataï¼‰</span>ï¼Œï¼ˆæœªåˆå§‹åŒ–æˆ–ä¸º 0 çš„å˜é‡ä¸éœ€è¦é‡å®šä½ï¼‰

`.strtab`ï¼šå­—ç¬¦ä¸²è¡¨ <span class="text-sm text-gray-5">ï¼ˆstring tableï¼‰</span> ï¼ŒåŒ…æ‹¬ï¼š 

<span class="text-sm text-gray-5">

- `.symtab` å’Œ `.debug` èŠ‚ä¸­çš„ç¬¦å·è¡¨
- èŠ‚å¤´éƒ¨ä¸­çš„èŠ‚åå­—

å­—ç¬¦ä¸²è¡¨å°±æ˜¯ä»¥ nullï¼ˆ`\0`ï¼‰ç»“å°¾çš„å­—ç¬¦ä¸²çš„åºåˆ—ã€‚

</span>


</div>


<div>


![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

<!-- 

è¿˜æœ‰ `.debug` èŠ‚ï¼Œå­˜å‚¨è°ƒè¯•ä¿¡æ¯ã€‚`.line` èŠ‚ï¼Œå­˜å‚¨è¡Œå·ä¿¡æ¯ã€‚

-->



---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

Relocatable Object File

<div grid="~ cols-2 gap-12">
<div>

### èŠ‚å¤´éƒ¨è¡¨

å­˜å‚¨ä¸åŒéƒ¨åˆ†çš„èµ·å§‹ä½ç½®ã€‚

</div>

<div>

![relocatable_object_file](./res/image/slides.assets/relocatable_object_file.png)

</div>
</div>

---

# å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

Executable Object File

<div grid="~ cols-2 gap-12">
<div text-sm>


ELF å¤´æè¿°æ–‡ä»¶çš„æ•´ä½“æ ¼å¼ï¼ŒåŒ…å«ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œå³ç¨‹åºè¿è¡Œæ—¶æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚

**æ®µ**ï¼šé“¾æ¥å™¨æ ¹æ®ç›®æ ‡æ–‡ä»¶ä¸­ **å±æ€§ç›¸åŒçš„å¤šä¸ªèŠ‚åˆå¹¶åçš„èŠ‚çš„é›†åˆ**{.text-sky-5}ï¼Œè¿™ä¸ªé›†åˆç§°ä¸ºæ®µã€‚

- `.init` æ®µï¼šæ¯”å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å¤šå‡ºæ¥çš„ï¼ŒåŒ…å«åˆå§‹ä»£ç ï¼ˆ`_init` å‡½æ•°ï¼‰ï¼Œä¼šåœ¨ç¨‹åºå¼€å§‹æ—¶è°ƒç”¨ã€‚
- `.text` `.rodata` `.data` æ®µï¼šä¸åŒåèŠ‚å¯¹åº”ï¼Œå·²è¢«é‡å®šä½åˆ°æœ€ç»ˆçš„è¿è¡Œæ—¶å†…å­˜åœ°å€ã€‚
- `.rel.text` å’Œ `.rel.data` èŠ‚ï¼šä¸å†å­˜åœ¨ï¼Œå› ä¸ºå·²ç»å®Œå…¨é“¾æ¥ã€‚

</div>

<div>

![executable_object_file](./res/image/slides.assets/executable_object_file.png){.mx-auto}

<span class="text-xs text-gray-5">

æ®µä»£è¡¨çš„æ˜¯å¯æ‰§è¡Œä»£ç å’Œæ•°æ®ç­‰å†…å­˜åŒºåŸŸï¼Œè€ŒèŠ‚åˆ™æ›´åŠ æŠ½è±¡ï¼Œå®ƒä»£è¡¨çš„æ˜¯æ–‡ä»¶ä¸­çš„ä¸€ç»„ç›¸å…³æ•°æ®ã€‚åœ¨ ELF æ–‡ä»¶ä¸­ï¼ŒèŠ‚æ˜¯æŒ‰ç…§åŠŸèƒ½å’Œç›®çš„æ¥åˆ’åˆ†çš„ï¼Œæ¯”å¦‚ä»£ç èŠ‚ã€æ•°æ®èŠ‚ã€ç¬¦å·è¡¨èŠ‚ç­‰ç­‰ï¼Œè€Œæ®µåˆ™æ˜¯æŒ‰ç…§å†…å­˜åŒºåŸŸæ¥åˆ’åˆ†çš„ã€‚

</span>

</div>
</div>



---

# åŠ è½½å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

Loading an Executable Object File

<div grid="~ cols-2 gap-12">
<div>

### å†…å­˜å¸ƒå±€{.mb-2}

- **ä»£ç æ®µ**ï¼šä»åœ°å€ `0x400000` = $2^{21}$ å¼€å§‹ï¼Œåé¢æ˜¯æ•°æ®æ®µ
- **å †å†…å­˜**ï¼šç”± `malloc` åˆ†é…ï¼Œè¿è¡Œæ—¶å †åœ¨æ•°æ®æ®µä¹‹å
- **ç”¨æˆ·æ ˆ**ï¼šä»æœ€å¤§åˆæ³•ç”¨æˆ·åœ°å€ $2^{48} - 1$ å‘ä¸‹å¢é•¿
- **å†…æ ¸åŒº**ï¼šä»åœ°å€ $2^{48}$ å¼€å§‹ï¼Œç”¨äºå†…æ ¸ä»£ç å’Œæ•°æ®æ®µ
- ä¸­é—´å¯èƒ½æœ‰é—´éš”ï¼šå¯¹é½è¦æ±‚

`_start`ï¼ˆå…¥å£ç‚¹ï¼‰ â†’ `_libc_start_main`ï¼ˆå®šä¹‰åœ¨ libc.so ä¸­ï¼‰ â†’ `main`

</div>

<div>

![runtime_memory](./res/image/slides.assets/runtime_memory.png){.mx-auto}

</div>
</div>

<!-- 

å®é™…ä¸Šå­˜åœ¨ è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼Œä»¥åŠ ASLRï¼ˆæ¯æ¬¡ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿™äº›åŒºåŸŸçš„**åœ°å€éƒ½ä¼šæ”¹å˜**ï¼Œä½†**ç›¸å¯¹ä½ç½®ä¸å˜**ï¼‰

libc.soï¼šä¸€å®šä¼šè¢«é“¾æ¥ã€‚

-->




---

# ç¬¦å·å’Œç¬¦å·è¡¨

Symbols and Symbol Table

æ¯ä¸ªå¯é‡å®šä½ç›®æ ‡æ¨¡å— $m$ éƒ½æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼ŒåŒ…å«ç¬¦å·çš„å®šä¹‰å’Œå¼•ç”¨è¯¦æƒ…ï¼Œå®ƒä»¬åŒ…æ‹¬ï¼š

- **å…¨å±€ç¬¦å·**ï¼š$m$ å®šä¹‰å¹¶èƒ½è¢«å…¶ä»–æ¨¡å— $n$ å¼•ç”¨çš„ï¼Œå¯¹åº”éé™æ€çš„ C å‡½æ•°å’Œå…¨å±€å˜é‡ã€‚
- **å±€éƒ¨ç¬¦å·**ï¼š$m$ å®šä¹‰ä¸” **åª**{.text-sky-5} åœ¨æ¨¡å— $m$ å†…è‡ªå·±ä½¿ç”¨çš„ï¼Œå¯¹åº”å¸¦ `static` å±æ€§çš„ C å‡½æ•°å’Œå…¨å±€å˜é‡ï¼Œè¿™äº›ç¬¦å·åœ¨æ¨¡å— $m$ å†…ä»»ä½•ä½ç½®éƒ½å¯è§ã€‚
- **å¤–éƒ¨ç¬¦å·**ï¼š$m$ å¼•ç”¨ä½† $m$ ä¸­ **æœªå®šä¹‰**{.text-sky-5} çš„ï¼Œå¯¹åº”å…¶ä»–æ¨¡å— $n$ å®šä¹‰çš„å‡½æ•°æˆ–å…¨å±€å˜é‡ã€‚

ç¬¦å·è¡¨ **ä¸å…³å¿ƒæœ¬åœ°éé™æ€ç¨‹åºå˜é‡**ï¼Œå¦‚ï¼š

```c{2}
int main() {
    int a = 1;
    return 0;
}
```

è¿™é‡Œçš„ `a` æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œè€Œæ˜¯å‡ºç°åœ¨æ ˆä¸­ã€‚

<button @click="$nav.go(14)">ğŸ”™</button>



---

# Static å±æ€§

`static` Attribute

`static` å®šä¹‰çš„å‡½æ•°å’Œå…¨å±€å˜é‡ **åªèƒ½åœ¨å…¶å£°æ˜æ¨¡å—ä¸­ä½¿ç”¨ï¼ˆç±»ä¼¼ C++ çš„ `private`ï¼‰**{.text-sky-5}ï¼Œå¯¹å…¶ä»–æ¨¡å—ä¸å¯è§ã€‚

ç¼–è¯‘å™¨ä¼šåœ¨ `.data` æˆ– `.bss` ä¸­ä¸ºå…¶åˆ†é…ç©ºé—´ï¼Œåˆ›é€ ä¸€ä¸ªå…·æœ‰å”¯ä¸€åå­—çš„ç¬¦å·ã€‚

<div grid="~ cols-2 gap-12">
<div text-sm>

åœ¨å³ä¾§ä»£ç ä¸­ï¼š

- å¸¦æœ‰ `static` å…³é”®å­—çš„å˜é‡ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œä¸”åœ¨ `.data` æˆ– `.bss` ä¸­åˆ†é…ç©ºé—´
- æœªå¸¦æœ‰ `static` å…³é”®å­—çš„å˜é‡ä¸ä¼šå‡ºç°åœ¨ç¬¦å·è¡¨ä¸­ï¼Œè€Œæ˜¯å‡ºç°åœ¨æ ˆä¸­
- ç”±äºå‡ºç°äº†é‡åçš„ `static` å˜é‡ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä¸åŒåç§°çš„å±€éƒ¨é“¾æ¥å™¨ç¬¦å·ï¼Œå¦‚ `x.1` è¡¨ç¤ºå‡½æ•° `f` ä¸­çš„é™æ€å˜é‡ï¼Œè€Œ `x.2` è¡¨ç¤ºå‡½æ•° `g` ä¸­çš„é™æ€å˜é‡


</div>

<div>


```c
int f() {
    static int x = 0;
    int y = 1;
    return x + y;
}

int g() {
    static int x = 1;
    int y = 2;
    return x + y;
}
```

</div>
</div>



---

# ç¬¦å·è¡¨ç»“æ„

Symbol Table Structure

<div grid="~ cols-2 gap-12">
<div text-sm>

- `name`ï¼šæŒ‡å‘ç¬¦å·çš„ nullï¼ˆ`\0`ï¼‰ ç»“æŸçš„å­—ç¬¦ä¸²åå­—
- `value`
  - å¯¹äºå¯é‡å®šä½çš„æ¨¡å—æ¥è¯´ï¼Œè¡¨ç¤ºç›¸å¯¹äºå®šä¹‰æ‰€åœ¨èŠ‚ï¼ˆ`section`ï¼‰èµ·å§‹ä½ç½®çš„åç§»
  - å¯¹äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ¥è¯´ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªç»å¯¹è¿è¡Œæ—¶åœ°å€
- `size`ï¼šç›®æ ‡çš„å¤§å°ï¼ˆå­—èŠ‚ä¸ºå•ä½ï¼‰
- `type`ï¼šç¬¦å·ç±»å‹ï¼ˆå‡½æ•°æˆ–æ•°æ®ï¼‰
- `binding`ï¼šç¬¦å·æ˜¯å¦æ˜¯æœ¬åœ°çš„è¿˜æ˜¯å…¨å±€çš„ï¼ˆæ˜¯å¦å¯ä»¥è¢«å…¶ä»–æ¨¡å—å¼•ç”¨ï¼Œå³æœ‰æ—  `static` å…³é”®å­—ï¼‰<button @click="$nav.go(12)">ğŸ’¡</button>
- `section`ï¼šç¬¦å·æ‰€åœ¨çš„èŠ‚

</div>

<div>

```c
typedef struct {
    int name;        // .strtab ä¸­çš„åç§»
    char type:4,     // å‡½æ•°æˆ–æ•°æ®
         binding:4;  // å±€éƒ¨æˆ–å…¨å±€
    char reserved;   // æ˜¯å¦ä½¿ç”¨
    short section;   // èŠ‚å¤´éƒ¨è¡¨ç´¢å¼•
    long value;      // èŠ‚å†…åç§»æˆ–ç»å¯¹åœ°å€
    long size;       // å¯¹è±¡å¤§å°ï¼ˆå­—èŠ‚ï¼‰
} Elf64_Symbol;
```

</div>
</div>



---

# ç¬¦å·è¡¨æ¡ç›®åˆ†é…

Allocation of Symbol Table Entries

æ¯ä¸ªç¬¦å·å°†è¢«åˆ†é…åˆ°ç›®æ ‡æ–‡ä»¶çš„æŸä¸ªèŠ‚ï¼ˆsectionï¼‰ï¼Œå¦‚ `.text` `.data` `.bss` ç­‰ã€‚

æœ‰ä¸‰ä¸ªç‰¹æ®Šçš„ä¼ªèŠ‚ï¼ˆpseudosectionï¼‰ï¼Œå®ƒä»¬åœ¨èŠ‚å¤´éƒ¨è¡¨ä¸­æ˜¯æ²¡æœ‰æ¡ç›®çš„ï¼š

- `ABS`ï¼šä»£è¡¨ä¸è¯¥è¢«é‡å®šä½çš„ç¬¦å·ï¼ˆabsoluteï¼‰
- `UNDEF`ï¼šä»£è¡¨æœªå®šä¹‰çš„ç¬¦å·ï¼ˆundefinedï¼‰
- `COMMON`ï¼šæœªè¢«åˆ†é…ä½ç½®çš„æœªåˆå§‹åŒ–çš„æ•°æ®ç›®æ ‡

`COMMON` vs `.bss`ï¼š

- `COMMON`ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œ**ä»è€Œå®ƒä»¬å¯èƒ½å®šä¹‰åœ¨å…¶ä»–æ¨¡å—ä¸­**{.text-sky-5}
- `.bss`ï¼šæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–ä¸º 0 çš„å…¨å±€æˆ–é™æ€å˜é‡ï¼Œ**å¿…ç„¶å®šä¹‰åœ¨å½“å‰æ¨¡å—ä¸­**{.text-sky-5}

<br>

```c
int a; // æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå±äº COMMON
static int b; // æœªè¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œå±äº .bss
```




---
clicks: 5
---

# ç¬¦å·è¡¨æ¡ç›®åˆ†é…

Allocation of Symbol Table Entries

<div class="text-sm">

å¯¹äº `m.o` å’Œ `swap.o` æ¨¡å—ï¼Œå¯¹æ¯ä¸ªç¬¦å·åœ¨ `swap.o` ä¸­å®šä¹‰æˆ–å¼•ç”¨çš„ç¬¦å·ï¼ŒæŒ‡å‡ºæ˜¯å¦åœ¨ **æ¨¡å— `swap.o` çš„ `.symtab` èŠ‚**{.text-sky-5} ä¸­æœ‰ä¸€ä¸ªç¬¦å·æ¡ç›®ã€‚å¦‚æœæ˜¯ï¼Œè¯·æŒ‡å‡ºè¯¥ç¬¦å·çš„æ¨¡å—ï¼ˆ`swap.o` æˆ–è€… `m.o`ï¼‰ã€ç¬¦å·ç±»å‹ï¼ˆå±€éƒ¨ã€å…¨å±€æˆ–è€…å¤–éƒ¨ï¼‰ä»¥åŠå®ƒåœ¨æ¨¡å—ä¸­è¢«åˆ†é…åˆ°çš„èŠ‚ï¼ˆ`.text`ã€`.data`ã€`.bss` æˆ– `COMMON`ï¼‰ã€‚

<div grid="~ cols-2 gap-4">
<div grid="~ cols-2 gap-4">
<div>

```c
// m.c
void swap();
int buf[2] = {1, 2};

int main() 
{
    swap();
    return 0;
}
```

</div>

<div>

```c
// swap.c
extern int buf [];

int *bufp0 = &buf[0];
int *bufp1;

void swap(){
  int temp;

  bufp1 = &buf[1];
  temp = *bufp0;
  *bufp0 = *bufp1;
  *bufp1 = temp;
}
```

</div>
</div>

<div text-xs>

<div :class="$clicks>0 ? 'hidden' : ''">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚  |
| ----- | :-----------: | -------- | ---------------- | --- |
| buf   |               |          |                  |     |
| bufp0 |               |          |                  |     |
| bufp1 |               |          |                  |     |
| swap  |               |          |                  |     |
| temp  |               |          |                  |     |

</div>
<div :class="$clicks==1 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚  |
| ----- | :-----------: | -------- | ---------------- | --- |
| buf   |       âœ”       | å¤–éƒ¨     | m.o              | UND |
| bufp0 |               |          |                  |     |
| bufp1 |               |          |                  |     |
| swap  |               |          |                  |     |
| temp  |               |          |                  |     |


</div>
<div :class="$clicks==2 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚    |
| ----- | :-----------: | -------- | ---------------- | ----- |
| buf   |       âœ”       | å¤–éƒ¨     | m.o              | UND   |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data |
| bufp1 |               |          |                  |       |
| swap  |               |          |                  |       |
| temp  |               |          |                  |       |


</div>
<div :class="$clicks==3 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å¤–éƒ¨     | m.o              | UND    |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |               |          |                  |        |
| temp  |               |          |                  |        |


</div>
<div :class="$clicks==4 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å¤–éƒ¨     | m.o              | UND    |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |       âœ”       | å…¨å±€     | swap.o           | .text  |
| temp  |               |          |                  |        |


</div>
<div :class="$clicks==5 ? '' : 'hidden'">

| ç¬¦å·  | .symtab æ¡ç›®? | ç¬¦å·ç±»å‹ | åœ¨å“ªä¸ªæ¨¡å—ä¸­å®šä¹‰ | èŠ‚     |
| ----- | :-----------: | -------- | ---------------- | ------ |
| buf   |       âœ”       | å¤–éƒ¨     | m.o              | UND    |
| bufp0 |       âœ”       | å…¨å±€     | swap.o           | .data  |
| bufp1 |       âœ”       | å…¨å±€     | swap.o           | COMMON |
| swap  |       âœ”       | å…¨å±€     | swap.o           | .text  |
| temp  |       âœ˜       | å±€éƒ¨     | swap.o           |        |


</div>
</div>
</div>
</div>



---

# ç¬¦å·è§£æ

Symbol Resolution

ç¬¦å·è§£æï¼šåœ¨å¤šä¸ªæ¨¡å—é—´ï¼Œå°†æ¯ä¸ªå¼•ç”¨ä¸ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚


é“¾æ¥æ—¶ï¼Œå°†ç¼–è¯‘å™¨è¾“å‡ºçš„å…¨å±€ç¬¦å·åˆ†ä¸ºï¼š

- **å¼ºç¬¦å·**{.text-sky-5}ï¼šåŒ…å«å‡½æ•°å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡
- **å¼±ç¬¦å·**{.text-sky-5}ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡

é€‰æ‹©è§„åˆ™ï¼šï¼ˆç ”è®¨é¢˜1.5ï¼‰

1. ä¸å…è®¸æœ‰å¤šä¸ªåŒåçš„å¼ºç¬¦å·
2. å¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™é€‰æ‹©å¼ºç¬¦å·
3. å¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™ä»è¿™äº›å¼±ç¬¦å·ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ªï¼ˆä¸€èˆ¬é€‰æ‹©ç¬¬ä¸€ä¸ªï¼‰

å¤šä¸ªå…¨å±€ç¬¦å·åŒåçš„æ—¶å€™ï¼Œå³ä½¿ä¸è¿èƒŒä¸Šè¿°è§„åˆ™ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨é—®é¢˜ï¼šç±»å‹æ··æ·†ã€é¢„æœŸä»¥å¤–çš„ä½œç”¨ç­‰ã€‚

ä¸ºäº†å®‰å…¨ï¼Œå°½é‡ä½¿ç”¨ `static` å±æ€§å®šä¹‰å…¨å±€å˜é‡ã€‚



---

# ç¬¦å·è§£æçš„é—®é¢˜

Symbol Resolution Problems

<div grid="~ cols-3 gap-4">
<div>

### Case 1

```c
// foo1.c
int main()
{
    return 0;
}

// bar1.c
int main() // é‡å¤å®šä¹‰å¼ºç¬¦å·
{
    return 0;
}
```

</div>

<div>

### Case 2

```c
// foo2.c
int x = 15213;
int main()
{
    return 0;
}

// bar2.c
int x = 15213; // é‡å¤å®šä¹‰å¼ºç¬¦å·
int f()
{
    return 0;
}
```


</div>

<div>

### Case 3

```c
// foo3.c
#include <stdio.h>
void f(void);
int x = 15213;
int main()
{
    f(); // ä¼šä¿®æ”¹ x çš„å€¼
    printf("x = %d\n", x);
    return 0;
}

// bar3.c
int x;
void f()
{
    x = 15212;
}
```

</div>
</div>


---

# ç¬¦å·è§£æçš„é—®é¢˜

Symbol Resolution Problems

### Case 4

<div grid="~ cols-3 gap-8">
<div>


```c
// foo4.c
#include <stdio.h>
void f(void);

int y = 15212; // é«˜åœ°å€
int x = 15213; // ä½åœ°å€

int main()
{
    f();
    printf("x = 0x%x y = 0x%x\n",
            x, y);
    // 0x0 0x80000000
    return 0;
}
```

</div>

<div>

```c
// bar4.c
double x;

void f()
{
    x = -0.0;
}
```

</div>

<div>

`x` ä¼šæŒ‰ç…§ `double`ï¼ˆ8 å­—èŠ‚ï¼‰çš„æ–¹å¼è®¡ç®—ï¼Œä½†å®é™…ä¸Š `x` åªå ç”¨ 4 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼ˆå› ä¸ºå®ƒæ˜¯ `int` ç±»å‹ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å¯¹å†…å­˜çš„éæ³•è®¿é—®ã€‚

</div>
</div>

---

# ç¬¦å·è§£æ

Symbol Resolution 

ç ”è®¨é¢˜1.4

<div grid="~ cols-2 gap-12">
<div>


```c
//main.c
int sum(int *a, int n);
int sum1(int *a, int n);
int array[2] = {1, 2};

int main(int argc, char** argv)
{
    int val = sum(array, 2);
    return val;
}
//sum.c
int sum(int *a, int n)
{
    int i, s = 0;
    for (i = 0; i < n; i++) {
        s += a[i];
    }
    return s;
}
```

</div>

<div>

```shell
objdump -t main.o

main.o:     file format elf64-x86-64

SYMBOL TABLE:
0000000000000000 l  df *ABS*  0000000000000000 main.c
0000000000000000 l  d  .text  0000000000000000 .text
0000000000000000 g  O .data  0000000000000008 array
0000000000000000 g  F .text  000000000000002f main
0000000000000000       *UND*  0000000000000000 sum

objdump -t sum.o

sum.o:     file format elf64-x86-64

SYMBOL TABLE:
0000000000000000 l  df *ABS*  0000000000000000 sum.c
0000000000000000 l  d  .text  0000000000000000 .text
0000000000000000 g   F .text  0000000000000049 sum
```


</div>
</div>



---

# é™æ€åº“

Static Libraries

ç ”è®¨é¢˜2.1ï¼š

**é™æ€åº“ï¼ˆStatic Libraryï¼‰**ï¼šæ˜¯ä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œé€šè¿‡å°†è¿™äº›ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æ¥å®ç°ä»£ç çš„é‡ç”¨ã€‚é™æ€åº“åœ¨ç¼–è¯‘æ—¶é“¾æ¥åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰ä»£ç çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

### Why é™æ€åº“ï¼Ÿ{.mb-4}

1. åŒºåˆ†æ ‡å‡†å‡½æ•° / ç¨‹åºå‡½æ•°ï¼šå¤æ‚ 
2. æ‰€æœ‰æ ‡å‡†å‡½æ•°æ”¾ä¸€èµ·ï¼Œå­˜ä¸ºå•ç‹¬çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼šæ–‡ä»¶ä½“ç§¯å¤ªå¤§ï¼Œç»´æŠ¤è¦é‡æ–°æ‰“åŒ…
3. æ¯ä¸ªå‡½æ•°ä¸€ä¸ªæ¨¡å—ï¼šæ–‡ä»¶å¤šã€ç»´æŠ¤å¤æ‚ï¼Œæ‰‹åŠ¨æŒ‡å®šé“¾æ¥ç´¯æ­»äº†
4. ç›¸å…³çš„å‡½æ•°æ‰æ”¾åœ¨ä¸€èµ·ï¼šâœ”âœ”âœ”



---

# é™æ€åº“çš„åˆ›å»ºå’Œä½¿ç”¨

Creating and Using Static Libraries

<div grid="~ cols-2 gap-8">

<div>

### åˆ›å»ºé™æ€åº“{.my-2}

1. ç¼–è¯‘æºæ–‡ä»¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼Œobject fileï¼‰ã€‚
    ```bash
    gcc -c addvec.c multvec.c # -c åªç¼–è¯‘ï¼Œä¸é“¾æ¥
    ```
2. ä½¿ç”¨ `ar`ï¼ˆarchiveï¼‰å·¥å…·å°†ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆé™æ€åº“ï¼š
    ```bash
    ar rcs libvector.a addvec.o multvec.o
    ```
</div>

<div>


### ä½¿ç”¨é™æ€åº“{.my-2}

1. ç¼–è¯‘ä½¿ç”¨é™æ€åº“çš„ç¨‹åºæ–‡ä»¶ã€‚
    ```bash
    gcc -c main2.c
    ```
2. é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‡å®šé™æ€åº“çš„ä½ç½®ã€‚
    ```bash
    gcc -static -o prog2c main2.o ./libvector.a
    ```
    `-static`ï¼šæŒ‡å®šé™æ€é“¾æ¥ï¼Œæ— éœ€è¿è¡Œæ—¶é“¾æ¥<br>
    æˆ–è€…ä½¿ç”¨ `-L` å’Œ `-l` å‚æ•°ï¼ˆlibraryï¼‰ï¼š
    ```bash
    gcc -static -o prog2c main2.o -L. -lvector
    ```
3. Cç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºæ€»æ˜¯ä¼ é€`libc.a`ç»™é“¾æ¥å™¨ã€‚

</div>
</div>



---

# è§£æé™æ€åº“å¼•ç”¨

Resolving Static Library References

ç ”è®¨é¢˜2.3

å¯¹äºä¸€è¡Œä»£ç ï¼Œé“¾æ¥å™¨ä»å·¦åˆ°å³æŒ‰éœ€è§£æåº“ä¸­çš„ç¬¦å·ï¼š

```bash
gcc foo.c libx.a liby.a libx.a
```

é›†åˆå®šä¹‰ï¼š

- $E$ï¼šæœ€ç»ˆæ‰€éœ€è¦çš„æˆå‘˜ç›®æ ‡æ–‡ä»¶ï¼ˆExportedï¼‰ï¼Œç›®æ ‡æ–‡ä»¶è‚¯å®šä¸¢è¿›å»ï¼Œå­˜æ¡£æ–‡ä»¶çœ‹æœ‰æ²¡æœ‰ç”¨ä¸Šå†å†³å®šã€‚
- $U$ï¼šæœªè§£æçš„ç¬¦å·ï¼ˆUndefinedï¼‰ï¼Œæ²¡å®šä¹‰çš„ç¬¦å·å°±å…ˆåŠ è¿›å»ï¼Œé‡åˆ°å­˜æ¡£æ–‡ä»¶å†çœ‹èƒ½ä¸èƒ½åŒ¹é…ä¸Šã€‚
- $D$ï¼šå·²å®šä¹‰çš„ç¬¦å·ï¼ˆDefinedï¼‰ï¼Œå·²ç»åŒ¹é…ä¸Šã€æ‰¾åˆ°å®šä¹‰çš„ç¬¦å·ã€‚

è§£æå®Œæˆåï¼Œä¸åœ¨ $E$ ä¸­çš„æˆå‘˜ç›®æ ‡æ–‡ä»¶ä¼šè¢«ä¸¢æ‰ï¼ˆç”¨ä¸ä¸Šï¼‰ã€‚

è§£æå®Œæˆåï¼Œ$U$ éç©ºï¼Œé“¾æ¥å™¨ä¼šè¾“å‡ºä¸€ä¸ªé”™è¯¯å¹¶ç»ˆæ­¢ã€‚



---

# è§£æé™æ€åº“å¼•ç”¨

Resolving Static Library References

å› ä¸ºä»å·¦åˆ°å³è§£æï¼Œæ‰€ä»¥åœ¨å‘½ä»¤è¡Œé“¾æ¥çš„é¡ºåºå˜å¾—è‡³å…³é‡è¦ã€‚

```bash
gcc foo.c libx.a liby.a libz.a
```

å’Œ

```bash
gcc foo.c libz.a liby.a libx.a
```

ç»“æœä¸ä¸€æ ·ï¼Œå‰è€…ä¼šæŠ¥é”™ï¼Œåè€…ä¸ä¼šã€‚

- `.a` æ–‡ä»¶ä¸­ä¹Ÿå¯èƒ½æœ‰æœªå®šä¹‰çš„ç¬¦å·ï¼Œä¹Ÿå¯èƒ½ä¾èµ–äºå…¶ä»– `.a` æ–‡ä»¶
- åœ¨è§£æè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ª `.a`  æ–‡ä»¶å¯ä»¥å‡ºç°å¤šæ¬¡ã€‚
- `.o`æ–‡ä»¶ä¸ä¼šä¸¢å¼ƒï¼Œåªè¦åŠ å…¥ä¸€æ¬¡

æ€ä¹ˆåšé¢˜ï¼š**ç”»å‡ºä¾èµ–å›¾ï¼Œæ»¡è¶³æœ€ç»ˆçš„æ¬¡åºèƒ½å¤Ÿéå†æ¯æ¡æœ‰å‘è¾¹ã€‚**



---

# é‡å®šä½

Relocation

ç ”è®¨é¢˜1.7


**é‡å®šä½èŠ‚**ï¼šå°†æ‰€æœ‰ç›¸åŒç±»å‹çš„èŠ‚åˆå¹¶ä¸ºåŒä¸€ç±»å‹çš„æ–°çš„èšåˆèŠ‚ï¼Œå¹¶æŠŠè¿è¡Œæ—¶å†…å­˜åœ°å€èµ‹ç»™æ–°çš„èšåˆèŠ‚ã€‚è¿™æ ·ï¼Œç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤å’Œå…¨å±€å˜é‡éƒ½æœ‰å”¯ä¸€çš„è¿è¡Œæ—¶å†…å­˜åœ°å€äº†ã€‚

**é‡å®šä½ç¬¦å·**ï¼šé“¾æ¥å™¨ä¼šä¿®æ”¹ä»£ç èŠ‚å’Œæ•°æ®èŠ‚ä¸­å¯¹æ¯ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œä½¿å¾—å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶å†…å­˜åœ°å€ã€‚è¿™ä¸€æ­¥ä¾èµ–äºå¯é‡å®šä½ç›®æ ‡æ¨¡å—ä¸­çš„ **é‡å®šä½æ¡ç›®**ã€‚



---

# é‡å®šä½æ¡ç›®

Relocation Entries

å½“ **æ±‡ç¼–å™¨** ç”Ÿæˆä¸€ä¸ªç›®æ ‡æ¨¡å—æ—¶ï¼Œå®ƒå¹¶ä¸çŸ¥é“æ•°æ®å’Œä»£ç æœ€ç»ˆå°†æ”¾åœ¨å†…å­˜ä¸­çš„ä»€ä¹ˆä½ç½®ã€‚

æ‰€ä»¥ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ª**é‡å®šä½æ¡ç›®**ï¼Œå‘Šè¯‰ **é“¾æ¥å™¨** å°†ç›®æ ‡æ–‡ä»¶åˆå¹¶æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶å¦‚ä½•ä¿®æ”¹è¿™ä¸ªå¼•ç”¨ã€‚

ä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ `.rel.text` ä¸­ï¼Œæ•°æ®çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ `.rel.data` ä¸­ã€‚

### ELF é‡å®šä½æ¡ç›®çš„æ ¼å¼

```c
typedef struct {
    long offset;    /* åç§»é‡ï¼šå¼•ç”¨é‡å®šä½çš„åç§»é‡ */
    long type:32;   /* é‡å®šä½ç±»å‹ */
    long symbol:32; /* ç¬¦å·è¡¨ç´¢å¼• */
    long addend;    /* å¸¸é‡éƒ¨åˆ†ï¼šé‡å®šä½è¡¨è¾¾å¼çš„å¸¸é‡éƒ¨åˆ† */
} Elf64_Rela;
```



---

# é‡å®šä½è¿‡ç¨‹

Relocation Process

### é‡å®šä½ç±»å‹{.mb-2}

- `R_X86_64_PC32`ï¼šé‡å®šä½ä¸€ä¸ªä½¿ç”¨ 32 ä½ PC ç›¸å¯¹åœ°å€çš„å¼•ç”¨
- `R_X86_64_32`ï¼šé‡å®šä½ä¸€ä¸ªä½¿ç”¨ 32 ä½ç»å¯¹åœ°å€çš„å¼•ç”¨

ç›¸å¯¹åœ°å€ï¼šè·ç¦» PC çš„**å½“å‰è¿è¡Œæ—¶å€¼**çš„åç§»é‡



---
clicks: 4
---

# é‡å®šä½è¿‡ç¨‹

Relocation Process

<div grid="~ cols-3 gap-4">
<div text-sm relative>

<div :class="$clicks==0 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

å‡è®¾ï¼š

- `ADDR(s)` å’Œ `ADDR(r.symbol)` è¡¨ç¤ºè¿è¡Œæ—¶åœ°å€ï¼Œä¸ä¹‹ç›¸å¯¹çš„ï¼Œ`s` è¡¨ç¤ºå½“å‰è¿˜æ²¡æœ‰é‡å®šä½æ—¶ï¼ŒåŸå§‹ç›®æ ‡æ–‡ä»¶çš„åœ°å€ã€‚
- ç¬¬ 3 è¡Œè®¡ç®—çš„æ˜¯éœ€è¦è¢«é‡å®šä½çš„ 4 å­—èŠ‚å¼•ç”¨çš„æ•°å€¼ $r$ ä¸­çš„åœ°å€ã€‚
- å¦‚æœè¿™ä¸ªå¼•ç”¨ä½¿ç”¨çš„æ˜¯ PC ç›¸å¯¹å¯»å€ï¼Œé‚£ä¹ˆå®ƒå°±ç”¨ç¬¬ 5ï½9 è¡Œæ¥é‡å®šä½ã€‚
- å¦‚æœè¯¥å¼•ç”¨ä½¿ç”¨çš„æ˜¯ç»å¯¹å¯»å€ï¼Œå®ƒå°±é€šè¿‡ç¬¬ 11ï½13 è¡Œæ¥é‡å®šä½ã€‚

</div>

<div :class="$clicks==1 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`refptr`ï¼šè®¡ç®—ä½ è¦ä¿®æ”¹çš„åœ°å€ï¼ˆåœ¨å“ªé‡Œï¼Œç°åœ¨ç•™ç€çš„æ˜¯ 00ï¼Œæˆ‘ä»¬éœ€è¦å¡«å†™ä¸Šæ­£ç¡®çš„åç§»é‡ / åœ°å€ï¼‰

</div>

<div :class="$clicks==2 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`refaddr`ï¼šé“¾æ¥åï¼Œå¡«å†™ç›¸å¯¹å€¼çš„åœ°å€

è¿™é‡Œåˆ©ç”¨äº†ï¼šåç§»é‡ï¼ˆ`r.offset`ï¼‰ä¸å˜ã€‚

</div>

<div :class="$clicks==3 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`r.addend`ï¼šè¡¥å¿ `refaddr` å’Œè¿è¡Œæ—¶ `PC` ä¹‹é—´çš„å·®å€¼

`refaddr = ADDR(PC) + r.addend`

è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰å¦‚ä¸‹å¼å­ï¼š

`PC = refaddr - r.addend`

`PC + *refptr = ADDR(r.symbol)`

è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç›¸å¯¹å®šä½ã€‚

</div>

<div :class="$clicks==4 ? 'opacity-100' : 'opacity-0'" transition duration-200 absolute>

`r.addend`ï¼šå¯¹äºç»å¯¹é‡å®šä½æ¥è®²ï¼Œä¸€èˆ¬å°±è®¾ç½®ä¸º 0 äº†ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥å°±æœ‰ï¼š

`*refptr = ADDR(r.symbol)`

</div>


</div>

<div col-span-2>

```c {all|3|3,7|5-10|12-16}{at:1}
foreach section s {  /* è¿­ä»£èŠ‚ */
    foreach relocation entry r {  /* è¿­ä»£é‡å®šä½æ¡ç›® */
        refptr = s + r.offset;  /* éœ€è¦é‡å®šä½çš„å¼•ç”¨çš„æŒ‡é’ˆï¼Œè¦å†™å“ªé‡Œ */

        /* é‡å®šä½ PC-relative å¼•ç”¨ */
        if (r.type == R_X86_64_PC32) {
            refaddr = ADDR(s) + r.offset;  /* å¼•ç”¨çš„è¿è¡Œæ—¶åœ°å€ */
            /* addend = -4 */
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr);
        }

        /* é‡å®šä½ç»å¯¹å¼•ç”¨ */
        if (r.type == R_X86_64_32) {
            /* addend = 0 */
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend); 
        }
    }
}
```

</div>
</div>


---

<div grid="~ cols-2 gap-8">
<div>

# ç›¸å¯¹é‡å®šä½ä¸¾ä¾‹

PC-relative Relocation Example


<div class="text-xs">


```
r.offset = 0xf
r.symbol = sum
r.type = R_X86_64_PC32
r.addend = -4
```

- `r.offset`ï¼š`call` æŒ‡ä»¤ç¬¬äºŒä¸ªå­—èŠ‚ä¸ `main` å‡½æ•°èµ·å§‹åœ°å€çš„åç§»é‡ = `0xf`
- `r.refptr`ï¼šè¦ä¿®æ”¹çš„åœ°å€ï¼Œ`s + r.offset` = `main + 0xf` = `0xf`
- `refaddr`ï¼šå¼•ç”¨çš„è¿è¡Œæ—¶åœ°å€ = `ADDR(s) + r.offset` = `0x4004d0 + 0xf` = `0x4004df`
- `PC`ï¼šè¿è¡Œæ—¶çš„ PCï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ = `0x4004e3`
- `r.addend`ï¼šè¡¥å¿ `refaddr` å’Œè¿è¡Œæ—¶ `PC` ä¹‹é—´çš„å·®å€¼ = `0x4004df - 0x4004e3 = -4`
- `ADDR(r.symbol)`ï¼šçœŸå®è¦å¾—åˆ°çš„åœ°å€ï¼Œä¹Ÿå³ `sum` çš„è¿è¡Œæ—¶åœ°å€ = `0x4004e8`

`*refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr) = (unsigned) (0x4004e8 + (-4) - 0x4004df) = 5`

</div>

</div>

<div>

![relocate_relative](./res/image/slides.assets/relocate_relative.png){.mx-auto}

</div>
</div>


---

<div grid="~ cols-2 gap-8">
<div>


# ç»å¯¹é‡å®šä½ä¸¾ä¾‹

Absolute Relocation Example

<div class="text-xs">


```
r.offset = 0xa
r.symbol = array
r.type = R_X86_64_32
r.addend = 0
```

- `r.offset`ï¼š`call` æŒ‡ä»¤ç¬¬äºŒä¸ªå­—èŠ‚ä¸ `main` å‡½æ•°èµ·å§‹åœ°å€çš„åç§»é‡ = `0xa`
- `r.refptr`ï¼šè¦ä¿®æ”¹çš„åœ°å€ï¼Œ`s + r.offset` = `main + 0xa` = `0xa`
- `r.addend`ï¼šå¯¹äºç»å¯¹é‡å®šä½ï¼Œè®¾ç½®ä¸º 0ã€‚
- `ADDR(r.symbol)`ï¼šçœŸå®è¦å¾—åˆ°çš„åœ°å€ï¼Œä¹Ÿå³ `array` çš„è¿è¡Œæ—¶åœ°å€ = `0x601018`

`*refptr = (unsigned) (ADDR(r.symbol) + r.addend) = (unsigned) (0x601018 + 0) = 0x601018`

</div>

</div>

<div>

![relocate_absolute](./res/image/slides.assets/relocate_absolute.png){.mx-auto}

</div>
</div>



---

<div grid="~ cols-2 gap-12">
<div>

# åŠ¨æ€é“¾æ¥å…±äº«åº“

Dynamic Linking Shared Libraries

ç ”è®¨é¢˜2.4

<div>

å…±äº«åº“ï¼š**åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€åŠ è½½å’Œé“¾æ¥çš„åº“æ–‡ä»¶**{.text-sky-5}ï¼Œé€šå¸¸ä»¥ `.so`ï¼ˆLinuxï¼‰æˆ– `.dll`ï¼ˆWindowsï¼‰ä¸ºåç¼€ã€‚

- èŠ‚çœèµ„æºï¼šé¿å…é™æ€åº“å¤åˆ¶å¾ˆå¤šæ¬¡
- ç®€åŒ–æ›´æ–°ï¼šæ›´æ–°å…±äº«åº“åªéœ€æ›¿æ¢åº“æ–‡ä»¶ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–çš„ç¨‹åº
- åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œæ—¶åŠ è½½åº“æ–‡ä»¶ï¼Œå¤šä¸ªç¨‹åºå…±äº«åŒä¸€ä»½åº“æ–‡ä»¶

C æ ‡å‡†åº“ `libc.so` é€šå¸¸æ˜¯åŠ¨æ€é“¾æ¥çš„ã€‚

</div>

</div>

<div>

![dynamic_linking](./res/image/slides.assets/dynamic_linking.png){.mx-auto}

</div>
</div>



<!-- 

å›é¡¾é™æ€åº“çš„é“¾æ¥æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶åœ¨é“¾æ¥çš„è¿‡ç¨‹ä¸­ä»åº“ä¸­æå–å‡ºéœ€è¦æ‰§è¡Œçš„ä»£ç å’Œå…¶å®ƒå¯é‡å®šä½æ–‡ä»¶ä¸€èµ·ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ä½†æ˜¯è¿™æ ·åšä»æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼š
1.å¯¹äºä¸€äº›å¾ˆåŸºæœ¬çš„å‡½æ•°ï¼ˆæ¯”å¦‚I/Oæ“ä½œä¸­çš„printf,scanfç­‰ï¼‰ï¼Œåœ¨æ¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„textæ®µä¸­éƒ½ä¼šå­˜åœ¨å…¶çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™å¯¹äºç£ç›˜ç©ºé—´æ¥è¯´æ˜¯æå¤§çš„æµªè´¹è¡Œä¸ºã€‚
2.å¦‚æœåº“è¿›è¡Œäº†æ›´æ–°æˆ–è€…æ”¹åŠ¨ï¼Œå¿…é¡»é‡æ–°è¿›è¡Œé“¾æ¥è¡Œä¸ºä»¥ç”Ÿæˆæ–°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè¿™å¯¹ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæ¥è¯´æ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œå› ä¸ºå…¶æ„å‘³ç€ä¸€ä¸ªå°æ”¹åŠ¨å¯èƒ½ä¼šç‰µæ¶‰åˆ°å¾ˆå¤šæ˜¾å¼æ“ä½œï¼‰

å›å¿†æˆ‘ä»¬ä¹‹å‰çš„é“¾æ¥è¡Œä¸ºï¼Œæˆ‘ä»¬æ€»æ˜¯ä¿®æ”¹ä»£ç å½“ä¸­çš„å…¨å±€å˜é‡å’Œå‡½æ•°çš„åœ°å€ä»è€Œå®Œæˆé‡å®šä½è¡Œä¸ºï¼Œè¿™ç§æ–¹æ³•æ˜¯ä½æ•ˆè€Œâ€œç¬¨é‡â€çš„ï¼šè¿™æ„å‘³ç€åœ¨åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œæ¯ä¸€æ¬¡å¯¹å…¨å±€å˜é‡å’Œå‡½æ•°åœ°å€çš„æ”¹åŠ¨éƒ½ä¼šç‰µæ¶‰åˆ°å¼•ç”¨å…¶çš„æ‰€æœ‰ä»£ç çš„æ”¹å˜ã€‚æˆ‘ä»¬æ˜¾ç„¶ä¸å¸Œæœ›çœ‹åˆ°è¿™ç§è¡Œä¸ºã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä½ç½®æ— å…³ä»£ç æ¥ä¿è¯å³ä½¿æ˜¯ä½¿ç”¨åŠ¨æ€é“¾æ¥å…±äº«åº“ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šåœ¨è¿è¡Œä¸­æ”¹å˜ä»£ç æ®µ(.text)ï¼ˆåœ¨é™æ€é“¾æ¥çš„è¿‡ç¨‹ä¸­å› ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åªä¼šç”¨åˆ°è‡ªå·±å¤åˆ¶åˆ°å†…å­˜å½“ä¸­çš„ä¸œè¥¿ï¼Œæ‰€ä»¥è¿™ä»¶äº‹æƒ…æ˜¯æ˜¾ç„¶çš„ï¼‰


 -->


---

<div grid="~ cols-2 gap-12">
<div>

# åŠ¨æ€é“¾æ¥å…±äº«åº“

Dynamic Linking Shared Libraries

<div>
ç ”è®¨é¢˜2.5

#### é“¾æ¥å™¨ã€åŠ è½½å™¨ã€åŠ¨æ€é“¾æ¥å™¨ {.mb-2.mt-4}

- **é“¾æ¥å™¨**ï¼šåœ¨ç¼–è¯‘é˜¶æ®µä¹‹åå·¥ä½œï¼Œå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶å’Œåº“æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“æ–‡ä»¶ã€‚
- åŠ¨æ€é“¾æ¥ä¸­é“¾æ¥å™¨åªå¤åˆ¶äº†ä¸€äº›é‡å®šä½å’Œç¬¦å·è¡¨ä¿¡æ¯ã€‚
- **åŠ è½½å™¨**ï¼šåœ¨ç¨‹åºæ‰§è¡Œé˜¶æ®µå·¥ä½œï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°å†…å­˜å¹¶å‡†å¤‡å¥½æ‰§è¡Œç¯å¢ƒã€‚
- **åŠ¨æ€é“¾æ¥å™¨**ï¼šåœ¨åŠ è½½å™¨å°†ç¨‹åºåŠ è½½åˆ°å†…å­˜åã€ç¨‹åºå¼€å§‹æ‰§è¡Œå‰å·¥ä½œï¼Œè´Ÿè´£åœ¨è¿è¡Œæ—¶åŠ è½½åŠ¨æ€åº“å¹¶è§£æç¬¦å·ï¼ˆé‡å®šä½ï¼‰ã€‚

</div>

</div>

<div>

![dynamic_linking](./res/image/slides.assets/dynamic_linking.png){.mx-auto}

</div>
</div>

---

# é™æ€ä¸åŠ¨æ€å¯¹æ¯”
Compare

ç ”è®¨é¢˜2.6

<div grid="~ cols-2 gap-12">
<div>

## é™æ€ï¼š
<br>

- æ²¡æœ‰è¿è¡Œæ—¶é“¾æ¥éœ€è¦æŸ¥æ‰¾ã€é‡å®šä½çš„å¼€é”€
- ä¸éœ€è¦ä½åˆ—é‡å®šä½å‡½æ•°éœ€è¦çš„PLTå ç”¨çš„å¼€é”€
- ç›¸è¾ƒäºå¤åˆ¶å¤šæ¬¡ï¼Ÿ

</div>

<div>

## åŠ¨æ€ï¼š
<br>

- èŠ‚çœèµ„æºï¼šé¿å…é™æ€åº“å¤åˆ¶å¾ˆå¤šæ¬¡
- ç®€åŒ–æ›´æ–°ï¼šæ›´æ–°å…±äº«åº“åªéœ€æ›¿æ¢åº“æ–‡ä»¶ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ‰€æœ‰ä¾èµ–çš„ç¨‹åº
- åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œæ—¶åŠ è½½åº“æ–‡ä»¶ï¼Œå¤šä¸ªç¨‹åºå…±äº«åŒä¸€ä»½åº“æ–‡ä»¶
- å¤šæ¬¡ä½¿ç”¨ï¼Œå‘½ä¸­ç‡é«˜


</div>
</div>




---
clicks: 1
---

# ä½ç½®æ— å…³ä»£ç 

Position Independent Code

ä½ç½®å›ºå®šï¼šä¼šå¼•èµ·å†…å­˜çš„æµªè´¹ï¼Œæ— æ³•é«˜æ•ˆåˆ©ç”¨ï¼ˆWhy?ï¼‰

<div :class="$clicks>0 ? 'opacity-100' : 'opacity-0'" transition duration-200>

ä½ç½®æ— å…³ï¼šå…±äº«åº“å¯ä»¥è¢«åŠ è½½åˆ°å†…å­˜çš„ä»»ä½•ä½ç½®ï¼Œä»è€Œå¤šä¸ªç¨‹åºå¯ä»¥åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªå…±äº«åº“å®ä¾‹ï¼ŒèŠ‚çœå†…å­˜ã€‚

<span class="text-sm text-gray-5">

éœ€è¦ä½¿ç”¨ `-fpic` ï¼ˆflag position independent codeï¼‰é€‰é¡¹ç¼–è¯‘å…±äº«åº“

</span>

</div>

---

# è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰ å’Œ å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰

Procedure Link Table and Global Offset Table, PLT & GOT

æ•°æ®å¼•ç”¨

- åŠ¨æ€é“¾æ¥å™¨é‡å®šä½GOTä¸­æ¡ç›®

![dynamic_linking](./newres/image/W10/30.png){.w-150}


---

# è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰ å’Œ å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰

Procedure Link Table and Global Offset Table, PLT & GOT

å»¶è¿Ÿç»‘å®š
<br>

å‡è®¾æœ‰ä¸€ä¸ªå…±äº«åº“å‡½æ•° `foo`ï¼Œä»¥ä¸‹æ˜¯è°ƒç”¨è¿‡ç¨‹ï¼š

1. åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ `foo` æ—¶ï¼Œç¨‹åºè·³è½¬åˆ° PLT è¡¨çš„ `foo` å…¥å£
2. PLT è¡¨çš„ `foo` å…¥å£è·³è½¬åˆ° **åŠ¨æ€é“¾æ¥å™¨çš„è§£æå‡½æ•°**{.text-sky-5}
3. åŠ¨æ€é“¾æ¥å™¨è§£æ `foo` çš„åœ°å€ï¼Œå¹¶å°†åœ°å€å†™å…¥ GOT è¡¨ä¸­ç›¸åº”çš„æ¡ç›®
4. åŠ¨æ€é“¾æ¥å™¨è¿”å›ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ `foo` å‡½æ•°
5. ä¸‹ä¸€æ¬¡è°ƒç”¨ `foo` æ—¶ï¼ŒPLT è¡¨ç›´æ¥ä» GOT è¡¨ä¸­è¯»å– `foo` çš„åœ°å€å¹¶è·³è½¬ï¼Œ**æ— éœ€å†æ¬¡è§£æ**{.text-sky-5}



<!-- 

å¦‚æœä»£ç ä½ç½®æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆæ¯ä¸ªç¨‹åºæˆ–åº“éƒ½éœ€è¦åœ¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œã€‚è¿™ä¼šå¯¼è‡´å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿå’Œæµªè´¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºéœ€è¦å ç”¨ç‰¹å®šçš„å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆåœ¨è¯¥åŒºåŸŸå†…çš„å…¶ä»–å†…å­˜ç©ºé—´å¯èƒ½ä¼šè¢«æµªè´¹æ‰ã€‚ä½ç½®æ— å…³ä»£ç å…è®¸ç¨‹åºå’Œåº“åœ¨å†…å­˜ä¸­çš„ä»»æ„ä½ç½®åŠ è½½å’Œæ‰§è¡Œï¼Œä»è€Œæ›´é«˜æ•ˆåœ°åˆ©ç”¨å†…å­˜ç©ºé—´ã€‚

 -->

---
clicks: 8
---

# PLT å’Œ GOT ä¸¾ä¾‹

PLT & GOT Example

<div grid="~ cols-2 gap-12">
<div>

```asm{all|1,2|1,2|1,2,7|1,2,7|1,2,7|1,2,4,7|1,2,4-5,7}{at:1}
# æ•°æ®æ®µ
# å…¨å±€åç§»é‡è¡¨ (GOT)
GOT[0]: addr of .dynamic
GOT[1]: addr of reloc entries # é‡å®šä½æ¡ç›®çš„åœ°å€
GOT[2]: addr of dynamic linker # åŠ¨æ€é“¾æ¥å™¨çš„åœ°å€
GOT[3]: 0x4005b6 # sys startup
GOT[4]: 0x4005c6 # addvec()
GOT[5]: 0x4005d6 # printf()
```

```asm
# ä»£ç æ®µ
callq 0x4005c0 # call addvec()
```

```asm{all|1|6-7|6-7|6-8|6-9|1-3,6-9|1-4,6-9}{at:1}
# è¿‡ç¨‹é“¾æ¥è¡¨ (PLT)
# PLT[0]: call dynamic linker
4005a0: pushq *GOT[1]
4005a6: jmpq *GOT[2]
...
# PLT[2]: call addvec()
4005c0: jmpq *GOT[4]
4005c6: pushq $0x1 # addvec çš„ ID
4005cb: jmpq 4005a0
```

</div>

<div v-click="8">

```asm{1-2,7}
# æ•°æ®æ®µ
# å…¨å±€åç§»é‡è¡¨ (GOT)
GOT[0]: addr of .dynamic
GOT[1]: addr of reloc entries
GOT[2]: addr of dynamic linker
GOT[3]: 0x4005b6 # sys startup
GOT[4]: &addvec()
GOT[5]: 0x4005d6 # printf()
```

```asm
# ä»£ç æ®µ
callq 0x4005c0 # call addvec()
```

```asm{1,6-7}
# è¿‡ç¨‹é“¾æ¥è¡¨ (PLT)
# PLT[0]: call dynamic linker
4005a0: pushq *GOT[1]
4005a6: jmpq *GOT[2]
...
# PLT[2]: call addvec()
4005c0: jmpq *GOT[4]
4005c6: pushq $0x1
4005cb: jmpq 4005a0
```

</div>
</div>



---

# åº“æ‰“æ¡©æœºåˆ¶

Library Interposition

ç ”è®¨é¢˜2.7-2.9

**æ‰“æ¡©**ï¼šåœ¨è¿è¡Œæ—¶æ›¿æ¢åº“å‡½æ•°çš„è¡Œä¸ºã€‚

æ‰“æ¡©æœºåˆ¶æœ‰ä¸‰ç§ä¸»è¦æ–¹æ³•ï¼š
- ç¼–è¯‘æ—¶æ‰“æ¡©
- é“¾æ¥æ—¶æ‰“æ¡©
- è¿è¡Œæ—¶æ‰“æ¡©

---

# ç¼–è¯‘æ—¶æ‰“æ¡©

Compile-Time Interposition

<div grid="~ cols-2 gap-12">
<div>


```c
//malloc.h
#define malloc(size) mymalloc(size)
#define free(ptr) myfree(ptr)

void *mymalloc(size_t size);
void myfree(void *ptr);

//int.c
#include <stdio.h>
#include <malloc.h>

int main()
{
    int *p = malloc(32);
    free(p);
    return(0); 
}
```

</div>

<div>

```c
//mymalloc.c
#ifdef COMPILETIME
#include <stdio.h>
#include <malloc.h>

/* malloc wrapper function */
void *mymalloc(size_t size)
{
    void *ptr = malloc(size); 
    printf("malloc(%d)=%p\n", 
           (int)size, ptr); 
    return ptr;
} 

/* free wrapper function */
void myfree(void *ptr)
{
    free(ptr); 
    printf("free(%p)\n", ptr); 
}
#endif
```


</div>
</div>


---

# ç¼–è¯‘æ—¶æ‰“æ¡©

Compile-Time Interposition


**æ¦‚å¿µ**ï¼šé€šè¿‡åœ¨ç¼–è¯‘æºä»£ç æ—¶æ’å…¥æ‰“æ¡©å‡½æ•°æ¥å®ç°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `-D` ç¼–è¯‘é€‰é¡¹å°†æ ‡å‡†å‡½æ•°æ›¿æ¢ä¸ºè‡ªå®šä¹‰å‡½æ•°ã€‚

ç¼–è¯‘å‘½ä»¤ï¼š
```sh
gcc -DCOMPILETIME -c mymalloc.c
gcc -I. -o intc int.c mymalloc.o
```

- `-I.`ï¼šå‘Šè¯‰ç¼–è¯‘å™¨åœ¨å½“å‰ç›®å½•ï¼ˆ`.`ï¼‰ä¸­æŸ¥æ‰¾å¤´æ–‡ä»¶ï¼ˆIncludeï¼‰
- `-o intc`ï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶åä¸º `intc`
- `int.c`ï¼šæºæ–‡ä»¶
- `mymalloc.o`ï¼šè‡ªå®šä¹‰åŠ¨æ€åº“

è¿™æ ·åšåï¼Œä¼šåœ¨æœç´¢ `malloc` æ—¶ï¼Œä¼˜å…ˆæœç´¢ `mymalloc.o` ä¸­çš„ `malloc`ï¼Œç„¶åå†æœç´¢é€šå¸¸çš„ç³»ç»Ÿç›®å½•ã€‚

---

# é“¾æ¥æ—¶æ‰“æ¡©

Link-Time Interposition

<div grid="~ cols-2 gap-12">
<div>


```c
//malloc.h
#define malloc(size) mymalloc(size)
#define free(ptr) myfree(ptr)

void *mymalloc(size_t size);
void myfree(void *ptr);

//int.c
#include <stdio.h>
#include <malloc.h>

int main()
{
    int *p = malloc(32);
    free(p);
    return(0); 
}
```

</div>

<div>

```c
//mymalloc.c
//#ifdef LINKTIME
#include <stdio.h>

void *__real_malloc(size_t size);
void __real_free(void *ptr);

/* malloc wrapper function */
void *__wrap_malloc(size_t size)
{
    void *ptr = __real_malloc(size); /* Call libc malloc */
    printf("malloc(%d) = %p\n", (int)size, ptr);
    return ptr;
}

/* free wrapper function */
void __wrap_free(void *ptr)
{
    __real_free(ptr); /* Call libc free */
    printf("free(%p)\n", ptr);
}
//#endif
```


</div>
</div>


---



# é“¾æ¥æ—¶æ‰“æ¡©

Link-Time Interposition




**æ¦‚å¿µ**ï¼šåœ¨é“¾æ¥é˜¶æ®µï¼Œç”¨è‡ªå®šä¹‰å‡½æ•°æ›¿æ¢æ ‡å‡†åº“å‡½æ•°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `--wrap` é€‰é¡¹å‘Šè¯‰é“¾æ¥å™¨ç”¨è‡ªå®šä¹‰å‡½æ•°æ›¿æ¢æ ‡å‡†å‡½æ•°ã€‚

é“¾æ¥å‘½ä»¤ï¼š
```sh
gcc -c mymalloc.c # -c åªç¼–è¯‘ï¼Œä¸é“¾æ¥ï¼Œå¾—åˆ° mymalloc.o
gcc -c int.c # å¾—åˆ° int.o
# -Wlï¼šå°†åé¢çš„é€‰é¡¹ä¼ é€’ç»™é“¾æ¥å™¨ ldã€‚
gcc -Wl,--wrap,malloc \
    -Wl,--wrap,free \
    -o intl int.o mymalloc.o # é“¾æ¥æ—¶æ‰“æ¡©
```

ç»™é“¾æ¥å™¨ä¼ é€’çš„å‚æ•°æ˜¯`--wrap malloc`å’Œ`--wrap free`


---

# è¿è¡Œæ—¶æ‰“æ¡©

Runtime Interposition

<div grid="~ cols-2 gap-12">
<div>


```c
//mymalloc.c
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
/* malloc wrapper function */
void *malloc(size_t size)
{
    void *(*mallocp)(size_t size);
    char *error;

    mallocp = dlsym(RTLD_NEXT, "malloc"); 
    /* Get address of libc malloc */
    if ((error = dlerror()) != NULL) {
        fputs(error, stderr);
        exit(1);
    }
    char *ptr = mallocp(size); /* Call libc malloc */
    //SOME PROBLEMS HERE!!!!!
    printf("malloc(%d) = %p\n", (int)size, ptr);
    return ptr;
}
```

</div>

<div>

```c


/* free wrapper function */
void free(void *ptr)
{
    void (*freep)(void *) = NULL;
    char *error;

    if (!ptr)
        return;

    freep = dlsym(RTLD_NEXT, "free"); 
    /* Get address of libc free */
    if ((error = dlerror()) != NULL) {
        fputs(error, stderr);
        exit(1);
    }
    freep(ptr); /* Call libc free */
    printf("free(%p)\n", ptr);
}
```


</div>
</div>

---

# è¿è¡Œæ—¶æ‰“æ¡©

Runtime Interposition

**æ¦‚å¿µ**ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ¨æ€æ›¿æ¢åº“å‡½æ•°ã€‚

**å®ç°æ–¹å¼**ï¼šä½¿ç”¨ `LD_PRELOAD` ç¯å¢ƒå˜é‡åŠ è½½è‡ªå®šä¹‰åŠ¨æ€åº“ã€‚

```sh
gcc -shared -fpic -o mymalloc.so mymalloc.c -ldl
gcc -o intr int.c
LD_PRELOAD="./mymalloc.so" ./intr
```

- `-shared`ï¼šç”Ÿæˆå…±äº«åº“
- `-fpic`ï¼šç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼Œ**è¿™æ˜¯å…±äº«åº“æ‰€å¿…éœ€çš„ï¼Œå› ä¸ºå…±äº«åº“å¯ä»¥åŠ è½½åˆ°å†…å­˜ä¸­çš„ä»»ä½•ä½ç½®**{.text-sky-5}
- `-ldl`ï¼šé“¾æ¥åŠ¨æ€é“¾æ¥å™¨åº“ï¼Œ`libdl` æ˜¯åŠ¨æ€é“¾æ¥å™¨åº“
- `LD_PRELOAD`ï¼šç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šåœ¨è¿è¡Œç¨‹åºæ—¶åŠ è½½çš„è‡ªå®šä¹‰åŠ¨æ€åº“

---

# è¿è¡Œç»“æœ
Result

![image-20241017174218991](./newres/image/W10/48.png){.w-150}
<br>

![image-20241017174218991](./newres/image/W10/49.png){.w-150}
<br>

![image-20241017174218991](./newres/image/W10/50.png){.w-150}

What happened?

---

# è¿è¡Œç»“æœ
What happened?

![image-20241017174218991](./newres/image/W10/51.png){.w-150}

`printf`å’Œ`malloc`é€’å½’è°ƒç”¨

---

# è¿è¡Œç»“æœ
What happened?

ç®€å•çš„è§£å†³æ–¹æ³•ï¼šæŠŠå‡ºé—®é¢˜çš„æ³¨é‡Šæ‰å°±å¥½äº†ã€‚

æˆ–è€…æ”¹ä¸º
```c
char buf[128];
int len = sprintf(buf, "malloc called, size=%zu\n", size);
write(2, buf, len); 
```
<br>
é‡æ–°ç¼–è¯‘åŠ¨æ€åº“åè¿è¡Œ

![image-20241017174218991](./newres/image/W10/52.png){.w-150}

æ–‡ä»¶æè¿°ç¬¦2ä»£è¡¨`stderr`ï¼Œä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿå¤§çš„ç©ºé—´ï¼Œå› æ­¤ä¸ä¼šé€’å½’

---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Emphasis
</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>


---

# ç¼–è¯‘æµç¨‹

![å›¾ç‰‡2](./res/image/slides.assets/å›¾ç‰‡2.png){.w-110}

é¢„å¤„ç†å™¨`cpp` $\rightarrow$ ç¼–è¯‘å™¨`ccl` $\rightarrow$ æ±‡ç¼–å™¨`as`  $\rightarrow$ é“¾æ¥`ld` $\rightarrow$ åŠ è½½å™¨`loader`



---

# æ–‡ä»¶ç¬¦å·

- **æºæ–‡ä»¶ï¼ˆ.cï¼‰**ï¼šåŒ…å«äººç±»å¯è¯»çš„æºä»£ç ã€‚
- **é¢„å¤„ç†æ–‡ä»¶ï¼ˆ.iï¼‰**ï¼šåŒ…å«å±•å¼€çš„å®å’Œå¤´æ–‡ä»¶å†…å®¹ï¼ˆé€šè¿‡é¢„å¤„ç†ç”Ÿæˆï¼‰ã€‚
- **æ±‡ç¼–æ–‡ä»¶ï¼ˆ.sï¼‰**ï¼šC æ–‡ä»¶ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç ï¼ˆé€šè¿‡ç¼–è¯‘ç”Ÿæˆï¼‰ã€‚
- **ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰**ï¼šæ±‡ç¼–æ–‡ä»¶æˆ– C æ–‡ä»¶ç¼–è¯‘åçš„æœºå™¨ä»£ç ï¼ŒåŒ…å«ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ã€‚
- **é™æ€åº“æ–‡ä»¶ï¼ˆ.aï¼‰**ï¼šåŒ…å«å¤šä¸ª `.o` æ–‡ä»¶çš„å½’æ¡£æ–‡ä»¶ï¼Œç”¨äºé™æ€é“¾æ¥ã€‚
- **å…±äº«åº“æ–‡ä»¶ï¼ˆ.soï¼‰**ï¼šåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œç¨‹åºè¿è¡Œæ—¶åŠ è½½ã€‚
- **å¯æ‰§è¡Œæ–‡ä»¶**ï¼šæœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºï¼ŒåŒ…å«æ‰€æœ‰å·²è§£æçš„ç¬¦å·å’Œé‡å®šä½çš„ä»£ç ã€‚

**.c -> .o -> .a / .so -> å¯æ‰§è¡Œæ–‡ä»¶** æ˜¯ä¸€ä¸ªå¸¸è§çš„ç¼–è¯‘-é“¾æ¥-æ‰§è¡Œçš„å®Œæ•´æµç¨‹




---



# ç›®æ ‡æ–‡ä»¶-ELF


![image-20240105235901077](./res/image/slides.assets/image-20240105235901077.png)


---


# ç¬¦å·å’Œç¬¦å·è¡¨

- `.symtab`ï¼šä¸€ä¸ªç¬¦å·è¡¨ï¼Œå®ƒå­˜æ”¾åœ¨ç¨‹åºä¸­**å®šä¹‰**å’Œ**å¼•ç”¨**çš„å‡½æ•°å’Œå…¨å±€å˜é‡çš„ä¿¡æ¯

![image-20240106000629759](./res/image/slides.assets/image-20240106000629759.png)


---



# ä¼ªèŠ‚

- ä¼ªèŠ‚åªå­˜åœ¨äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œä¸å­˜åœ¨äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­
- `ABS`ï¼šä¸è¯¥è¢«é‡å®šä½çš„ç¬¦å·
- `UNDEF`ï¼šæœªå®šä¹‰çš„ç¬¦å·ï¼ˆåªæœ‰å¼•ç”¨ï¼‰
- `COMMON`ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ˆé€‚é…ç¬¦å·è§£æè§„åˆ™ï¼‰
  - åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡ä¸æ‰€æœ‰é™æ€å˜é‡å­˜æ”¾äº .bss ä¸­
  - åœ¨å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­ COMMON ä¿å­˜çš„æ•°æ®ä¼šè¿›å…¥ .bss

![PixPin_2024-11-13_11-02-30](./res/image/slides.assets/PixPin_2024-11-13_11-02-30.png)

---

# ç¤ºä¾‹


<div grid="~ cols-2 gap-2">

<div>

![PixPin_2024-11-13_19-38-42](./res/image/slides.assets/PixPin_2024-11-13_19-38-42.png){.w-50}


</div>

<div>

![PixPin_2024-11-13_19-37-00](./res/image/slides.assets/PixPin_2024-11-13_19-37-00.png)


</div>
</div>



---

# å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šé€šå¸¸ä»¥ `.o`ï¼ˆUnix/Linuxï¼‰ã€`.obj`ï¼ˆWindowsï¼‰ä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡ç¼–è¯‘æºæ–‡ä»¶ç”Ÿæˆã€‚ä¾‹å¦‚ï¼š

  ```bash
  gcc -c example.c -o example.o
  ```

- **ç¤ºä¾‹**ï¼šå‡è®¾æœ‰æ–‡ä»¶ `example.c`ï¼Œå°†å…¶ç¼–è¯‘ä¸º `example.o`ï¼Œå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ã€‚


å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šå¦‚ `.text` æ®µï¼ŒåŒ…å«ç¼–è¯‘ç”Ÿæˆçš„æœºå™¨æŒ‡ä»¤ã€‚
- **æ•°æ®æ®µ**ï¼šå¦‚ `.data`ï¼ˆå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼‰å’Œ `.bss`ï¼ˆæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼‰æ®µã€‚
- **ç¬¦å·è¡¨**ï¼šåˆ—å‡ºæ–‡ä»¶ä¸­çš„ç¬¦å·ï¼ˆå‡½æ•°ã€å˜é‡ç­‰ï¼‰å®šä¹‰å’Œå¼•ç”¨ã€‚
- **é‡å®šä½ä¿¡æ¯**ï¼šæ ‡è¯†å‡ºéœ€è¦åœ¨é“¾æ¥é˜¶æ®µè°ƒæ•´çš„åœ°å€ã€‚



---

# å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šåœ¨ Unix/Linux ç³»ç»Ÿä¸Šæ²¡æœ‰ç‰¹å®šåç¼€ï¼Œä¸€èˆ¬å‘½åä¸º `a.out` æˆ–ç›´æ¥ä»¥ç¨‹åºåç§°å‘½åï¼›åœ¨ Windows ç³»ç»Ÿä¸Šé€šå¸¸ä»¥ `.exe` ä½œä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡é“¾æ¥å™¨å°†å¤šä¸ª `.o` æ–‡ä»¶ç»„åˆå¹¶é‡å®šä½ç”Ÿæˆã€‚ä¾‹å¦‚ï¼š

  ```bash
  gcc main.o example.o -o example_program
  ```

- **ç¤ºä¾‹**ï¼šè¿è¡Œ `gcc main.o example.o -o example_program` åç”Ÿæˆçš„ `example_program` å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚

å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šåŒ…å«ç¨‹åºçš„æŒ‡ä»¤ï¼Œè®¾ç½®ä¸ºå¯æ‰§è¡Œã€‚
- **æ•°æ®æ®µ**ï¼šåŒ…å«ç¨‹åºçš„æ•°æ®ï¼Œå·²å®Œæˆé‡å®šä½ã€‚
- **ç¨‹åºå…¥å£**ï¼šæŒ‡æ˜ç¨‹åºå¼€å§‹æ‰§è¡Œçš„å…¥å£åœ°å€ã€‚
- **åŠ¨æ€é“¾æ¥ä¿¡æ¯**ï¼ˆè‹¥ä¸ºåŠ¨æ€é“¾æ¥ï¼‰ï¼šåŒ…å«å¯¹å…±äº«åº“çš„ä¾èµ–ä¿¡æ¯ã€‚



---



# å…±äº«ç›®æ ‡æ–‡ä»¶

#### æ–‡ä»¶ç±»å‹

- **æ–‡ä»¶åç¼€**ï¼šåœ¨ Unix/Linux ç³»ç»Ÿä¸Šä»¥ `.so` ä¸ºåç¼€ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šä»¥ `.dll` ä¸ºåç¼€ã€‚

- **ç”Ÿæˆæ–¹å¼**ï¼šé€šè¿‡ç¼–è¯‘å™¨æˆ–é“¾æ¥å™¨æŒ‡å®šç”Ÿæˆå…±äº«åº“ã€‚ä¾‹å¦‚ï¼š

  ```bash
  gcc -shared -fPIC example.c -o libexample.so
  ```

- **ç¤ºä¾‹**ï¼šè¿è¡Œ `gcc -shared -fPIC example.c -o libexample.so` åç”Ÿæˆçš„ `libexample.so` å°±æ˜¯ä¸€ä¸ªå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚

å…±äº«ç›®æ ‡æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **ä»£ç æ®µ**ï¼šåŒ…å«å…±äº«åº“çš„ä»£ç ï¼Œå¯ä»¥è¢«å¤šä¸ªç¨‹åºåŠ è½½å¹¶å…±äº«ã€‚
- **æ•°æ®æ®µ**ï¼šåŒ…å«å…±äº«åº“çš„å…¨å±€æ•°æ®ã€‚
- **åŠ¨æ€æ®µ**ï¼šè®°å½•å…±äº«åº“çš„ä¾èµ–å’Œç¬¦å·è¡¨ï¼Œç”¨äºåŠ¨æ€é“¾æ¥æ—¶ç¬¦å·è§£æã€‚
- **å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰å’Œè¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰**ï¼šç”¨äºå»¶è¿Ÿç»‘å®šçš„ç¬¦å·è§£ææœºåˆ¶ã€‚

---

![PixPin_2024-11-13_17-10-27](./res/image/slides.assets/PixPin_2024-11-13_17-10-27.png){.w-190}


---

# æµç¨‹æ¢³ç†


<div grid="~ cols-2 gap-2">

<div>

- **é™æ€é“¾æ¥**
  - ç¬¦å·è§£æ
    - ç¬¦å·å®šä¹‰
    - è§£æè§„åˆ™ï¼šå¼ºã€å¼±ã€æœªå®šä¹‰
    - è§£ææ–¹æ³•ï¼šEã€Uã€D
  - **é‡å®šä½**
    - é‡å®šä½æ¡ç›®ï¼ˆRelocation Entryï¼‰
    - é‡å®šä½ç±»å‹ï¼ˆPC-relativeã€absoluteï¼‰
    - é‡å®šä½ç®—æ³•ï¼ˆRelocation Algorithmï¼‰

</div>

<div>

![image-20240106004108713](./res/image/slides.assets/image-20240106004108713.png)

- æ³¨æ„ï¼š .o ä¸ .a çš„ä¸åŒ
  - **.o åœ¨é“¾æ¥ç®—æ³•ä¸­ä¼šç›´æ¥é‡å®šä½åŠ å…¥æ±‡ç¼–è€Œ .a åªä¼šåŠ å…¥å…¶è¢«å¼•ç”¨çš„ç¬¦å·**


</div>
</div>






---

# æµç¨‹æ¢³ç†

<div grid="~ cols-2 gap-2">

<div>

- **åŠ¨æ€é“¾æ¥**
  - dynamic linkerï¼š
    - (1) å°†åŠ¨æ€åº“åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­; 
    - (2) å¯¹å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ reference è¿›è¡Œé‡å®šä½ï¼ˆä¿®æ”¹ .text å’Œ .dataï¼‰
  - **PIC**ï¼šï¼ˆç¼–è¯‘ï¼‰å°†æºæ–‡ä»¶ç¼–è¯‘ä¸ºä½ç½®æ— å…³ä»£ç ï¼ŒåŠ è½½åˆ°ä¸åŒè¿›ç¨‹çš„ä¸åŒåœ°å€æ—¶ä¾ç„¶èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œ
    - **GOT**ï¼šï¼ˆé“¾æ¥ï¼‰ä¸ºæ¯ä¸ªå…¨å±€å˜é‡å’Œå¤–éƒ¨å‡½æ•°ä¿ç•™ä¸€ä¸ªæ¡ç›®ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å®é™…åœ°å€å¡«å…¥
    - **PLT**ï¼šï¼ˆåŠ è½½ï¼‰å¯¹äºåŠ¨æ€åº“ä¸­çš„å‡½æ•°è°ƒç”¨ï¼ŒPLT ä¼šä¿å­˜å‡½æ•°çš„å…¥å£åœ°å€


</div>

<div>


![image-20240106004133587](./res/image/slides.assets/image-20240106004133587.png){.w-70}

1. **åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“**ï¼Œå¹¶å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨ã€‚
2. **è§£æä¾èµ–å…³ç³»**ï¼ŒåŠ è½½æ‰€æœ‰ä¾èµ–çš„å…±äº«åº“ã€‚
3. **å‡†å¤‡ GOT å’Œ PLT** è¡¨ï¼Œç¡®ä¿ç¬¦å·å¯ä»¥è¢«åŠ¨æ€è§£æã€‚
4. **ç¬¦å·è§£æå’Œé‡å®šä½**ï¼Œåœ¨åˆæ¬¡åŠ è½½æ—¶å®Œæˆå¤§éƒ¨åˆ†ç¬¦å·çš„è§£æã€‚
5. **å»¶è¿Ÿç»‘å®š**ï¼Œå½“ç¬¬ä¸€æ¬¡è°ƒç”¨å…±äº«åº“çš„å‡½æ•°æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨è§£æç¬¦å·å¹¶ç»‘å®šã€‚
6. **å®Œæˆåˆå§‹åŒ–å¹¶è·³è½¬åˆ°å…¥å£ç‚¹**ï¼Œç¨‹åºå¼€å§‹æ­£å¸¸æ‰§è¡Œã€‚


</div>
</div>




---



# ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰

![image-20240106004209297](./res/image/slides.assets/image-20240106004209297.png)

---

# GOT

![image-20240106004327288](./res/image/slides.assets/image-20240106004327288.png)

---

# PLT

![image-20240106004418727](./res/image/slides.assets/image-20240106004418727.png)




---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Homework Review</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# 5.13-1

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/55.png){.w-120}
![image-20241017174218991](./newres/image/W10/56.png){.w-120}
</div>
<div>
<v-clicks>
A.

![image-20241017174218991](./newres/image/W10/53.png){.w-120}
![image-20241017174218991](./newres/image/W10/54.png){.w-60}
</v-clicks>
</div>
</div>

---

# 5.13-2

- B. æµ®ç‚¹æ•°åŠ æ³•ï¼Œ3.0
- C. æ•´æ•°åŠ æ³•ï¼Œ1.0
- D. å…³é”®è·¯å¾„æ˜¯`%xmm0`ä¸­çš„æµ®ç‚¹åŠ æ³•ï¼Œä¹˜æ³•å¯ä»¥å¹¶è¡Œåœ°è¿›è¡Œã€‚

---

# 5.14

![image-20241017174218991](./newres/image/W10/57.png){.w-150}

```c
int limit = length - 5;
for(i=0 ; i<limit ; i+=6)
{
  sum += udata[i]*vdata[i] + udata[i+1]*vdata[i+1] + udata[i+2]*vdata[i+2]
       + udata[i+3]*vdata[i+3] + udata[i+4]*vdata[i+4] + udata[i+5]*vdata[i+5];
}
for(;i<length;i++)
{
  sum += udata[i]*vdata[i];
}
*dest = sum;

```

- A.æ¯ä¸ªå…ƒç´ éƒ½éœ€è¦åŠ è½½æ“ä½œï¼Œè€Œå¤„ç†å™¨åªæœ‰ä¸¤ä¸ªåŠ è½½å•å…ƒï¼Œä¸€å‘¨æœŸæœ€å¤šè¿›è¡Œä¸¤æ¬¡åŠ è½½ã€‚
- B.å…³é”®è·¯å¾„ä»ä¸ºnä¸ªæµ®ç‚¹åŠ æ³•ï¼Œåªèƒ½é¡ºåºæ‰§è¡Œã€‚

---

# 5.15

![image-20241017174218991](./newres/image/W10/58.png){.w-150}

```c
int limit = length - 5;
data_t sum0=0,sum1=0,sum2=0,sum3=0,sum4=0,sum5=0;
for(i=0 ; i<limit ; i+=6)
{
  sum0 += udata[i]*vdata[i]; sum1 += udata[i+1]*vdata[i+1]; sum2 += udata[i+2]*vdata[i+2];
  sum3 += udata[i+3]*vdata[i+3]; sum4 += udata[i+4]*vdata[i+4]; sum5 += udata[i+5]*vdata[i+5];
}
for(;i<length;i++)
{
  sum0 += udata[i]*vdata[i];
}
*dest = sum0 + sum1 + sum2 + sum3 + sum4 + sum5;

```

- 1.0 æ˜¯ååé‡ç•Œé™ï¼Œk >= C*Læ»¡è¶³ï¼Œå› æ­¤ä¸‹é™å°±æ˜¯1.0ã€‚
- ä½†ä»ç„¶æœ‰å¾ªç¯å¼€é”€ç­‰ã€‚

---

# 5.16

![image-20241017174218991](./newres/image/W10/59.png){.w-150}

```c
int limit = length - 5;
for(i=0 ; i<limit ; i+=6)
{
  sum = sum + ( (udata[i]*vdata[i] + udata[i+1]*vdata[i+1]) + 
              (udata[i+2]*vdata[i+2] + udata[i+3]*vdata[i+3]) + 
              (udata[i+4]*vdata[i+4] + udata[i+5]*vdata[i+5]) );
}
for(;i<length;i++)
{
  sum += udata[i]*vdata[i];
}
*dest = sum;

```

---

# 7.6

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/60.png){.w-120}

</div>
<div>

![image-20241017174218991](./newres/image/W10/61.png){.w-120}
<v-clicks>

![image-20241017174218991](./newres/image/W10/62.png){.w-120}
</v-clicks>
</div>
</div>

---

# 7.8

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/63.png){.w-120}

</div>
<div>

<v-clicks>

![image-20241017174218991](./newres/image/W10/64.png){.w-120}
</v-clicks>
</div>
</div>

---

# 7.16


![image-20241017174218991](./newres/image/W10/65.png){.w-180}

<v-clicks>

- A: `0x4004f8 - 0x4004e0 - 0xa - 4 = 0xa`
- B: `0x400500 - 0x4004d0 - 0xa - 4 = 0x22`
</v-clicks>


---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Exercises</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# E1

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/31.png){.w-120}
</div>
<div>

<v-clicks>


ç­”æ¡ˆï¼šD

</v-clicks>
</div>
</div>

---

# E2

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/32.png){.w-120}

</div>
<div>
<v-clicks>


![image-20241017174218991](./newres/image/W10/33.png){.w-120}

</v-clicks>
</div>
</div>
---


# E3

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/34.png){.w-120}

</div>
<div>
<v-clicks>


![image-20241017174218991](./newres/image/W10/35.png){.w-120}

</v-clicks>
</div>
</div>
---

# E4-1


![image-20241017174218991](./newres/image/W10/36.png){.w-150}

---

# E4-2


![image-20241017174218991](./newres/image/W10/37.png){.w-150}
<v-clicks>


![image-20241017174218991](./newres/image/W10/38.png){.w-120}

</v-clicks>

---

# E5

![image-20241017174223790](./res/image/slides.assets/image-20241017174223790.png)

---

# E5


![image-20241017174227177](./res/image/slides.assets/image-20241017174227177.png)
---

# E6

![image-20241017174230048](./res/image/slides.assets/image-20241017174230048.png){.w-180}

---

# E6

![image-20241017174234588](./res/image/slides.assets/image-20241017174234588.png)

---

# E7

![image-20241017174241180](./res/image/slides.assets/image-20241017174241180.png)

<!-- ![image-20241017174243441](./res/image/slides.assets/image-20241017174243441.png) -->

---

# E7

![image-20241017174241180](./res/image/slides.assets/image-20241017174241180.png)

![image-20241017174243441](./res/image/slides.assets/image-20241017174243441.png)
---

# E8

![image-20241017174246158](./res/image/slides.assets/image-20241017174246158.png){.w-180}

<!-- ![image-20241017174249438](./res/image/slides.assets/image-20241017174249438.png){.w-160} -->


---

# E8

![image-20241017174246158](./res/image/slides.assets/image-20241017174246158.png){.w-180}

![image-20241017174249438](./res/image/slides.assets/image-20241017174249438.png){.w-160}

---

# E9

![image-20241017174254345](./res/image/slides.assets/image-20241017174254345.png){.w-180}

---

# E9

![image-20241017174254345](./res/image/slides.assets/image-20241017174254345.png){.w-180}

![image-20241017174259426](./res/image/slides.assets/image-20241017174259426.png){.w-160}


---

# E10

![image-20241017174544182](./res/image/slides.assets/image-20241017174544182.png){.w-120}


---

# E10

![image-20241017174553937](./res/image/slides.assets/image-20241017174553937.png)


---

# E11

![image-20241017175337266](./res/image/slides.assets/image-20241017175337266.png){.w-140}

---

# E11

![image-20241017175342714](./res/image/slides.assets/image-20241017175342714.png){.w-180}
---

# E12

![image-20241017175348824](./res/image/slides.assets/image-20241017175348824.png)

<!-- ![image-20241017175351793](./res/image/slides.assets/image-20241017175351793.png) -->

---

# E12

![image-20241017175348824](./res/image/slides.assets/image-20241017175348824.png)

![image-20241017175351793](./res/image/slides.assets/image-20241017175351793.png)

---

# E13

![image-20241017175348824](./newres/image/W10/66.png){.w-120}

![image-20241017175351793](./newres/image/W10/67.png){.w-120}

---

# E13

![image-20241017175348824](./newres/image/W10/68.png)

---

# E14

<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/39.png){.w-120}

</div>
<div>

![image-20241017174218991](./newres/image/W10/40.png){.w-120}

<v-clicks>


![image-20241017174218991](./newres/image/W10/41.png){.w-120}

</v-clicks>
</div>
</div>

---


<div grid="~ cols-2 gap-2">
<div>

![image-20241017174218991](./newres/image/W10/42.png){.w-100}
![image-20241017174218991](./newres/image/W10/43.png){.w-110}

</div>
<div>

![image-20241017174218991](./newres/image/W10/44.png){.w-120}
![image-20241017174218991](./newres/image/W10/45.png){.w-120}

<v-clicks>


![image-20241017174218991](./newres/image/W10/46.png){.w-120}
![image-20241017174218991](./newres/image/W10/47.png){.w-120}

</v-clicks>
</div>
</div>

---
layout: center
---

<div>
  <text class="text-17 font-bold gradient-text">Notices</text>
</div>

<style>
  .gradient-text {
    background-image: linear-gradient(45deg, #4ec5d4 10%, #146b8c 20%);
    -webkit-background-clip: text;
    color: transparent;
  }
</style>

---

# è€ƒè¯•ä¸Lab
Test & Lab

- ç¬¬äºŒæ¬¡é˜¶æ®µæ€§æµ‹è¯•ï¼šè®°å¾—è‡ªå·±çš„å°ç­å·ï¼ˆ**17**ï¼‰
- æ—¶é—´ä¸å¤Ÿçš„æ—¶å€™**æŠ“é‡ç‚¹**ã€‚é“¾æ¥è¿™é‡Œæœ‰äº›åœ°æ–¹æä¸æ‡‚çš„å°±ç®—äº†(x)
- ECF å°ç­è¯¾ä»¶ï¼š~~å‘¨æœ«å‰~~å·²ç»å‘å‡º,ä¾›å‚è€ƒã€‚
- ç ”è®¨é¢˜æš‚å®šä¸å®‰æ’åŒå­¦ï¼Œä½œä¸šä»æ˜¯å‘¨äºŒæ™šå‰ddlï¼Œä½†å»ºè®®å¤§å®¶è€ƒå‰åšå®Œã€‚
- å‘¨æ—¥å‰æ”¾å‡ºç ”è®¨é¢˜è§£æå’Œä½œä¸šç­”æ¡ˆï¼ˆå¦‚æœé™†è€å¸ˆèƒ½æ—©ç‚¹å‘é¢˜çš„è¯ï¼‰ã€‚
- Arch Labï¼šPart C è§£æ³•
- Cache Lab: **å˜é‡æ•°è¦æ±‚ and æ³¨é‡Š**ã€‚
- Shell Labï¼šæ˜æ—¥ï¼ˆNov 13ï¼‰æ”¾å‡ºã€‚

---

# CacheLab
Style

å»å¹´(2024fall)æ ‡å‡†ï¼Œ**ä»…ä¾›å‚è€ƒ**ã€‚
<br/><br/>

****************************************
Style deductions (saturate at -7 points)
****************************************
* Missing or non-descriptive program header comment: -2 pts
* Missing or non-descriptive function header comments: -1 pt each,
Â  saturate at -2 pts
* Inconsistent indentation: -2 pts
* Lines greatly exceeding 80 chars (egregious only): -1 pt each, saturate at -2 pts
* Poor error checking: -1
* Any other egregious readability issue(s): -2 pts

---
layout: center
---

<div flex="~ gap-20"  mt-2 justify-center items-center>

<div  w-fit h-fit mb-2>

# THANKS

Made by WEB-05

webrun@stu.pku.edu.cn

<p class="text-gray-40">
  <font size = '3'>
    Reference: [WalkerCH]'s and [Arthals]'s presentations.<br>
  </font>
</p>


</div>

![wechat](./newres/image/w1/wechat.jpg){.w-50.rounded-md}

</div>
